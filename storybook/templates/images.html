<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>이미지 생성</title>
  <style>
    :root { --gap: 16px; --radius: 12px; --border: #e5e7eb; --card:#fff; --bg:#f9fafb; --text:#111827; --sub:#6b7280; --primary:#2563eb; --primary-hover:#1e40af; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:24px;max-width:1280px;margin:0 auto;padding:28px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}
    h1{font-size:22px;margin:0 0 16px 0}
    label{display:block;font-size:13px;color:var(--sub);margin-bottom:6px}
    select{width:100%;height:42px;border:1px solid var(--border);border-radius:10px;padding:0 12px;background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;height:44px;padding:0 14px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:600;cursor:pointer;white-space:nowrap}
    .btn:hover{background:#f3f4f6}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-hover);border-color:var(--primary-hover)}
    .btn-block{width:100%}
    .row{display:flex;gap:12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .thumb{width:100%;aspect-ratio:4/5;border:1px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;background:#fafafa;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .cap{font-size:13px;color:var(--sub);margin-top:8px}
    .foot{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
    .chk{display:flex;align-items:center;gap:8px}
    @media (max-width: 980px){.wrap{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 좌측 옵션 -->
    <aside class="panel">
      <h1>이미지 생성</h1>
      <label for="styleSel">스타일</label>
      <select id="styleSel">
        <option value="storybook_basic">동화 일러스트 (기본)</option>
        <option value="pencil">연필 스케치</option>
        <option value="watercolor">수채화</option>
      </select>

      <!-- 한 줄 전폭 버튼 -->
      <button id="btnAll" class="btn btn-primary btn-block" style="margin-top:16px">전체 이미지 생성</button>

      <!-- 두 개 나란히 -->
      <div class="row" style="margin-top:12px">
        <button id="btnSelected" class="btn btn-block">선택만 다시 생성</button>
        <button id="btnSave" class="btn btn-block">완성본 저장(JSON)</button>
      </div>

      <button id="btnBack" class="btn btn-block" style="margin-top:12px">글 편집으로</button>
    </aside>

    <!-- 우측 미리보기 -->
    <main class="panel">
      <div class="grid" id="grid"></div>
    </main>
  </div>

  <script>
    const KEY = 'storybook.last_story';
    const grid = document.getElementById('grid');
    const styleSel = document.getElementById('styleSel');

    let story = null;           // { title, pages[], images[] }
    let selected = new Set();   // 재생성 체크

    function loadStory() {
      const raw = localStorage.getItem(KEY);
      if (!raw) {
        alert('편집된 스토리가 없습니다. 글 편집 화면에서 내용을 작성해 주세요.');
        window.location.href = '/editor';
        return;
      }
      story = JSON.parse(raw);
      story.images = story.images || Array(story.pages.length).fill(null);
    }

    function render() {
      grid.innerHTML = '';
      story.pages.forEach((p, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="thumb" id="thumb-${i}">
            ${story.images[i] ? `<img src="${story.images[i]}" alt="">` : '이미지 없음'}
          </div>
          <div class="cap">${p || ''}</div>
          <div class="foot">
            <label class="chk">
              <input type="checkbox" data-i="${i}" ${selected.has(i) ? 'checked':''}>
              이 페이지 다시 생성
            </label>
            <button class="btn" data-rerun="${i}">다시 생성</button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    async function callGenerate(onlyIdx = null) {
      const payload = {
        pages: story.pages.slice(),
        style: styleSel.value
      };
      if (Array.isArray(onlyIdx) && onlyIdx.length) {
        payload.only_indices = onlyIdx.slice();
      }
      const res = await fetch('/api/images/generate', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        alert('이미지 생성 실패');
        return;
      }
      const data = await res.json();
      // data.images: 길이가 pages와 같고, 새로 만든 자리만 URL, 나머지는 null
      if (Array.isArray(data.images)) {
        data.images.forEach((url, i) => {
          if (url) story.images[i] = url;
        });
        // UI 반영 & 저장
        localStorage.setItem(KEY, JSON.stringify(story));
        render();
      } else {
        alert('응답 형식 오류');
      }
    }

    // 초기화
    loadStory();
    render();

    // 전체 생성
    document.getElementById('btnAll').addEventListener('click', () => callGenerate());

    // 선택만 다시 생성
    document.getElementById('btnSelected').addEventListener('click', () => {
      if (selected.size === 0) {
        alert('다시 생성할 페이지를 선택하세요.');
        return;
      }
      callGenerate([...selected].sort((a,b)=>a-b));
    });

    // 각 카드의 체크/다시생성 버튼
    grid.addEventListener('change', (e) => {
      const i = e.target.getAttribute('data-i');
      if (i !== null) {
        const idx = parseInt(i, 10);
        if (e.target.checked) selected.add(idx);
        else selected.delete(idx);
      }
    });
    grid.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-rerun]');
      if (!btn) return;
      const i = parseInt(btn.getAttribute('data-rerun'), 10);
      callGenerate([i]);
    });

    // 저장(JSON)
    document.getElementById('btnSave').addEventListener('click', async () => {
      const res = await fetch('/api/story/save', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(story)
      });
      const data = await res.json();
      alert(data && data.saved ? '저장 완료' : '저장 실패');
    });

    // 뒤로
    document.getElementById('btnBack').addEventListener('click', () => {
      localStorage.setItem(KEY, JSON.stringify(story));
      window.location.href = '/editor';
    });
  </script>
</body>
</html>