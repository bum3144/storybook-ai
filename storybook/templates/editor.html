<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
  <title>ê¸€ í¸ì§‘</title>
  <style>
    :root { --gap: 24px; --brand: #2563eb; --muted: #6b7280; }
    body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:#f7f9fb; color:#111827; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 24px; margin: 0 0 18px; display: flex; align-items: center; gap: 10px; }
    .grid { display: grid; grid-template-columns: 340px 1fr; gap: 28px; }
    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px; }
    input[type="text"], input[type="number"], textarea, select { width: 100%; border: 1px solid #d1d5db; border-radius: 10px; padding: 10px; box-sizing: border-box; }
    textarea { height: 120px; resize: vertical; }
    .btn { border: 1px solid #d1d5db; background: #f8f9fb; padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
    .btn:hover { background: #f1f5f9; }
    .btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .btn.primary:hover { background: #1d4ed8; }
    .btn.success { background: #10b981; color: #fff; border-color: #10b981; }
    .btn.success:hover { background: #059669; }
    .btn.warn { background: #f59e0b; color: #fff; border-color: #f59e0b; }
    .btn.warn:hover { background: #d97706; }

    .page-box { border: 1px dashed #e5e7eb; border-radius: 12px; padding: 14px; margin-bottom: 16px; }
    .mode-pill { display: inline-flex; padding: 3px 8px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 13px; }
    .hidden { display: none !important; }

    /* ë²„íŠ¼ ê·¸ë£¹ ë ˆì´ì•„ì›ƒ */
    .btn-full { width: 100%; margin-top: 10px; padding: 10px; font-weight: 500; }
    .btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 20px; }
    .btn-row .btn { padding: 10px 0; font-size: 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“ ê¸€ í¸ì§‘ <span id="modePill" class="mode-pill">ì§ì ‘ ì“°ê¸°</span></h1>

    <div class="grid">
      <div class="panel">
        <h2>ê¸°ë³¸ ì •ë³´</h2>
        <label>ì œëª©</label>
        <input id="titleInput" type="text" placeholder="ì˜ˆ: ì§€í™˜ì´ì˜ ëª¨í—˜ ì¼ê¸°" style="margin-bottom:15px"/>

        <label>í˜ì´ì§€ ìˆ˜ (1~5)</label>
        <input id="pageCountInput" type="number" min="1" max="5" value="3" />

        <hr style="border:0; border-top:1px solid #eee; margin:20px 0"/>

        <section id="aiSection">
          <h2>AI ì¶”ì²œ ë°›ê¸°</h2>
          <div style="display:flex; flex-direction:column; gap:10px">
            <input id="metaGenre" type="text" placeholder="ì¥ë¥´ (ì˜ˆ: ëª¨í—˜)">
            <input id="metaWorld" type="text" placeholder="ë°°ê²½ (ì˜ˆ: ìš°ì£¼)">
            <input id="metaTheme" type="text" placeholder="ì£¼ì œ (ì˜ˆ: ìš©ê¸°)">
            <input id="metaHero" type="text" placeholder="ì£¼ì¸ê³µ (ì˜ˆ: ê³ ì–‘ì´)">
          </div>

          <button id="btnAiPlot" class="btn primary btn-full">AIë¡œ ì¶”ì²œ í”Œë¡¯ ìƒì„±</button>
        </section>

        <button id="btnToggleMode" class="btn btn-full">ì§ì ‘ ì“°ê¸° ëª¨ë“œë¡œ ì „í™˜</button>

        <div class="btn-row">
          <button id="btnHome" class="btn">ëŒ€ì‹œë³´ë“œ</button>
          <button id="btnSave" class="btn warn">ì„ì‹œ ì €ì¥</button>
          <button id="btnToImages" class="btn success">ì´ë¯¸ì§€ ìƒì„±</button>
        </div>
      </div>

      <div class="panel">
        <h2>í˜ì´ì§€ë³„ ë¬¸ì¥</h2>
        <div id="pagesWrap"></div>
        <div style="margin-top:15px">
          <button id="btnAddPage" class="btn">+ í˜ì´ì§€ ì¶”ê°€</button>
          <button id="btnDelPage" class="btn">- í˜ì´ì§€ ì œê±°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const MAX_PAGES = 5;
    const el = {
      title: document.getElementById('titleInput'),
      pageCount: document.getElementById('pageCountInput'),
      pagesWrap: document.getElementById('pagesWrap'),
      btnAdd: document.getElementById('btnAddPage'),
      btnDel: document.getElementById('btnDelPage'),
      btnAiPlot: document.getElementById('btnAiPlot'),
      modePill: document.getElementById('modePill'),
      aiSection: document.getElementById('aiSection'),
      btnToggleMode: document.getElementById('btnToggleMode'),
      btnToImages: document.getElementById('btnToImages'),
      btnSave: document.getElementById('btnSave'),
      btnHome: document.getElementById('btnHome'),
      metaGenre: document.getElementById('metaGenre'),
      metaWorld: document.getElementById('metaWorld'),
      metaTheme: document.getElementById('metaTheme'),
      metaHero: document.getElementById('metaHero')
    };

    let MODE = (new URL(location.href).searchParams.get('mode') || 'write') === 'ai' ? 'ai' : 'direct';

    function init() {
      applyModeUI();
      try {
        const saved = JSON.parse(localStorage.getItem('story_draft'));
        if(saved && saved.pages) {
          el.title.value = saved.title || '';
          renderPages(saved.pages);
          return;
        }
      } catch(e){}
      renderPages(Array(3).fill(''));
    }

    function renderPages(contents) {
      const count = Math.min(Math.max(contents.length, 1), MAX_PAGES);
      el.pageCount.value = count;
      el.pagesWrap.innerHTML = '';

      for(let i=0; i<count; i++) {
        const pageContent = contents[i];
        let textValue = '';
        let keywordsValue = '';

        if (typeof pageContent === 'object' && pageContent !== null) {
            // ê°ì²´ì¸ ê²½ìš° (ì„ì‹œ ì €ì¥ ë¡œë“œ ì‹œ)
            textValue = pageContent.text || '';
            if (pageContent.keywords) {
                keywordsValue = pageContent.keywords.join(', ');
            }
        } else if (typeof pageContent === 'string') {
            // ë¬¸ìì—´ì¸ ê²½ìš° (Array(3).fill('') ì´ˆê¸°í™” ì‹œ)
            textValue = pageContent;
        }

        // [í•µì‹¬ ìˆ˜ì • ë¶€ë¶„]: textValueê°€ ì—¬ì „íˆ ê°ì²´ë¼ë©´ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì—ëŸ¬ ë°©ì§€
        if (typeof textValue === 'object' && textValue !== null) {
            textValue = JSON.stringify(textValue, null, 2);
        }

        const div = document.createElement('div');
        div.className = 'page-box';
        div.innerHTML = `
          <div style="font-weight:bold; margin-bottom:8px">í˜ì´ì§€ ${i+1}</div>
          <input type="text" class="kw-input" placeholder="í‚¤ì›Œë“œ (ì˜ˆ: ìˆ², ì•„ì¹¨)" style="margin-bottom:8px" value="${keywordsValue}">
          <textarea class="txt-area" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">${textValue}</textarea>
          <button class="btn" style="font-size:12px; margin-top:5px" onclick="retryPage(${i})">ì´ í˜ì´ì§€ë§Œ AIë¡œ ë‹¤ì‹œ ì“°ê¸°</button>
        `;
        el.pagesWrap.appendChild(div);
      }
    }

    function getPagesData() {
      const boxes = el.pagesWrap.querySelectorAll('.page-box');
      return Array.from(boxes).map((box, idx) => ({
        index: idx,
        text: box.querySelector('.txt-area').value,
        keywords: box.querySelector('.kw-input').value.split(',').filter(s=>s.trim())
      }));
    }

    // ëª¨ë“œ(AI/Direct)ì— ë”°ë¥¸ UI ìƒíƒœ ì—…ë°ì´íŠ¸
    function applyModeUI() {
      if(MODE === 'ai') {
        el.modePill.innerText = 'AIì™€ í•¨ê»˜ ì“°ê¸°';
        el.btnToggleMode.innerText = 'ì§ì ‘ ì“°ê¸° ëª¨ë“œë¡œ ì „í™˜';
        el.aiSection.classList.remove('hidden');
      } else {
        el.modePill.innerText = 'ì§ì ‘ ì“°ê¸°';
        el.btnToggleMode.innerText = 'AI ëª¨ë“œë¡œ ì „í™˜';
        el.aiSection.classList.add('hidden');
      }
    }

    // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì •ì˜ ---
    el.pageCount.addEventListener('change', () => {
      const cnt = parseInt(el.pageCount.value);
      const current = getPagesData();
      // í˜ì´ì§€ ìˆ˜ë¥¼ ëŠ˜ë¦´ ë•ŒëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ ì±„ìš°ê¸°
      if(cnt > current.length) while(current.length < cnt) current.push('');
      // í˜ì´ì§€ ìˆ˜ë¥¼ ì¤„ì¼ ë•ŒëŠ” ìë¥´ê¸°
      else current.length = cnt;

      renderPages(current);
    });

    el.btnAdd.onclick = () => {
      const current = getPagesData();
      if(current.length < MAX_PAGES) { current.push(''); renderPages(current); }
    };
    el.btnDel.onclick = () => {
      const current = getPagesData();
      if(current.length > 1) { current.pop(); renderPages(current); }
    };

    el.btnToggleMode.onclick = () => {
      MODE = MODE === 'ai' ? 'direct' : 'ai';
      applyModeUI();
    };

    el.btnHome.onclick = () => location.href = '/dashboard';

    el.btnSave.onclick = () => {
      const data = { title: el.title.value, pages: getPagesData() };
      localStorage.setItem('story_draft', JSON.stringify(data));
      alert('ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    // ì´ë¯¸ì§€ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™ (ì œëª© ìœ íš¨ì„± ê²€ì‚¬ í¬í•¨)
    el.btnToImages.onclick = async () => {
      const titleVal = el.title.value.trim();
      if (!titleVal) {
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        el.title.focus();
        return;
      }

      const data = { title: titleVal, pages: getPagesData() };

      el.btnToImages.disabled = true;
      el.btnToImages.innerText = 'ì´ë™ ì¤‘...';

      try {
        await fetch('/api/editor/cache', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        location.href = '/images';
      } catch (e) {
        console.error(e);
        alert('ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        el.btnToImages.disabled = false;
        el.btnToImages.innerText = 'ì´ë¯¸ì§€ ìƒì„±';
      }
    };

    // AI í”Œë¡¯ ìƒì„± ìš”ì²­ í•¸ë“¤ëŸ¬
    el.btnAiPlot.onclick = async () => {
      el.btnAiPlot.disabled = true;
      el.btnAiPlot.innerText = 'ìƒì„± ì¤‘...';
      try {
        const meta = {
          title: el.title.value,
          genre: el.metaGenre.value,
          world: el.metaWorld.value,
          theme: el.metaTheme.value,
          hero: el.metaHero.value
        };
        const pages = getPagesData();

        const res = await fetch('/api/plot/generate', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({meta, pages})
        });
        const data = await res.json();

        const boxes = el.pagesWrap.querySelectorAll('.page-box');
        data.pages.forEach(p => {
          if(boxes[p.index]) {
            let content = p.text;

            // AI ì‘ë‹µ íƒ€ì… ì˜ˆì™¸ ì²˜ë¦¬ (Object -> String)
            if (typeof content === 'object') {
                content = JSON.stringify(content, null, 2);
            }

            boxes[p.index].querySelector('.txt-area').value = content;
          }
        });
      } catch(e) {
          console.error(e);
          alert('ì˜¤ë¥˜ ë°œìƒ');
      }
      el.btnAiPlot.disabled = false;
      el.btnAiPlot.innerText = 'AIë¡œ ì¶”ì²œ í”Œë¡¯ ìƒì„±';
    };

    // ê°œë³„ í˜ì´ì§€ AI ì¬ìƒì„± í•¨ìˆ˜
    window.retryPage = async (idx) => {
      const boxes = el.pagesWrap.querySelectorAll('.page-box');
      const box = boxes[idx];
      const btn = box.querySelector('button');
      const txtArea = box.querySelector('.txt-area');

      btn.disabled = true;
      btn.innerText = 'ì“°ëŠ” ì¤‘...';

      try {
        const pageData = {
          index: idx,
          text: txtArea.value,
          keywords: box.querySelector('.kw-input').value.split(',')
        };
        const meta = { title: el.title.value };

        const res = await fetch('/api/plot/generate', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({meta, pages:[pageData]})
        });
        const data = await res.json();
        if(data.pages && data.pages[0]) {
          txtArea.value = data.pages[0].text;
        }
      } catch(e) { alert('ì˜¤ë¥˜'); }
      btn.disabled = false;
      btn.innerText = 'ì´ í˜ì´ì§€ë§Œ AIë¡œ ë‹¤ì‹œ ì“°ê¸°';
    };

    init();
  </script>
</body>
</html>