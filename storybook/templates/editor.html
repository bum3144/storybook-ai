<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ê¸€ í¸ì§‘</title>
  <style>
    :root { --gap:24px; --brand:#2563eb; --muted:#6b7280; }
    body { font-family: -apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",system-ui,sans-serif; background:#fff; color:#111827; }
    .wrap { max-width:1200px; margin:0 auto; padding:24px; }
    h1 { font-size:24px; margin:0 0 18px; display:flex; align-items:center; gap:10px; }
    .grid { display:grid; grid-template-columns:340px 1fr; gap:28px; }

    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:18px; }
    .panel h2 { font-size:16px; margin:0 0 12px; }
    .muted { color:var(--muted); font-size:13px; }

    label { display:block; font-size:13px; color:#374151; margin:10px 0 6px; }
    input[type="text"], input[type="number"], textarea, select {
      width:100%; box-sizing:border-box; border:1px solid #d1d5db; border-radius:10px;
      padding:10px 12px; font-size:14px; background:#fff;
    }
    textarea { height:120px; resize:vertical; }

    .btnbar { display:flex; gap:10px; flex-wrap:wrap; }
    .btn {
      border:1px solid #d1d5db; background:#f8f9fb; padding:10px 14px; border-radius:10px;
      cursor:pointer; font-size:14px;
    }
    .btn.primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn.ghost { background:#fff; }
    .btn.success { background:#10b981; color:#fff; border-color:#10b981; }
    .btn.warn { background:#f59e0b; color:#fff; border-color:#f59e0b; }

    .pages { display:flex; flex-direction:column; gap:16px; }
    .page-box { border:1px dashed #e5e7eb; border-radius:12px; padding:14px; }
    .page-title { font-weight:600; margin-bottom:8px; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spacer { height:10px; }

    .mode-pill { display:inline-flex; gap:8px; align-items:center; font-size:13px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“ ê¸€ í¸ì§‘ <span id="modePill" class="mode-pill">ì§ì ‘ ì“°ê¸°</span></h1>

  <div class="grid">
    <!-- ì¢Œì¸¡: ê¸°ë³¸ ì •ë³´ + AI ì¶”ì²œ ë°›ê¸° -->
    <div class="panel">
      <h2>ê¸°ë³¸ ì •ë³´</h2>

      <label>ì œëª©</label>
      <input id="titleInput" type="text" placeholder="ì˜ˆ: ì§€í™˜ì´ì˜ ëª¨í—˜ ì¼ê¸°"/>

      <div class="row">
        <div style="flex:1">
          <label>í˜ì´ì§€ ìˆ˜ (1~5)</label>
          <input id="pageCountInput" type="number" min="1" max="5" value="3"/>
          <div class="muted">í˜ì´ì§€ ìˆ˜ë¥¼ ë°”ê¾¸ë©´ í¸ì§‘ ì˜ì—­ì´ ìë™ìœ¼ë¡œ ë§ì¶°ì§‘ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="spacer"></div>
      <hr style="border:none;border-top:1px solid #eee;"/>
      <div class="spacer"></div>

      <h2>AI ì¶”ì²œ ë°›ê¸° <span class="muted" style="font-weight:400;font-size:12px">AIì™€ í•¨ê»˜ ì“°ê¸° ëª¨ë“œì—ì„œ ì‚¬ìš© ê¶Œì¥</span></h2>

      <label>í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
      <input id="keywordInput" type="text" placeholder="ì˜ˆ: ì”¨ì•—, ìˆ², ì¹œêµ¬"/>

      <div class="row" style="margin-top:8px">
        <label style="display:flex; align-items:center; gap:8px; margin:0">
          <input id="autoAdjustChk" type="checkbox" checked/>
          í‚¤ì›Œë“œ ê°œìˆ˜ì— ë§ì¶° í˜ì´ì§€ ìˆ˜ ìë™ ì¡°ì •
        </label>
        <span class="muted">(ìµœëŒ€ 5í˜ì´ì§€)</span>
      </div>

      <div class="spacer"></div>
      <button id="btnAiPlot" class="btn primary" style="width:100%">AIë¡œ ì¶”ì²œ í”Œë¡¯ ìƒì„±</button>

      <div class="spacer"></div>
      <div class="muted">â€» í˜„ì¬ëŠ” ê°„ë‹¨í•œ ëª©ì—… ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì‹¤ì œ Gemini/Imagenì€ ë‹¤ìŒ ë‹¨ê³„ ì—°ë™)</div>

      <div class="spacer"></div>
      <hr style="border:none;border-top:1px solid #eee;"/>
      <div class="spacer"></div>

      <div class="btnbar">
        <!-- 1ì¤„: ì´ì „/ëŒ€ì‹œë³´ë“œ/ì„ì‹œ ì €ì¥ -->
        <button id="btnPrev"    class="btn ghost">ì´ì „í˜ì´ì§€</button>
        <button id="btnHome"    class="btn ghost">ëŒ€ì‹œë³´ë“œ</button>
        <button id="btnSave"    class="btn warn">ì„ì‹œ ì €ì¥</button>
      </div>

      <div class="spacer"></div>
      <div class="btnbar">
        <!-- 2ì¤„: ëª¨ë“œ í† ê¸€ + ì´ë¯¸ì§€ ìƒì„± -->
        <button id="btnToggleMode" class="btn">AIì™€ í•¨ê»˜ ì“°ê¸°</button>
        <button id="btnToImages"   class="btn success" data-action="to-images">ì´ë¯¸ì§€ ìƒì„±</button>
      </div>
    </div>

    <!-- ìš°ì¸¡: í˜ì´ì§€ë³„ ë¬¸ì¥ -->
    <div class="panel">
      <h2>í˜ì´ì§€ë³„ ë¬¸ì¥</h2>
      <div id="pagesWrap" class="pages"></div>

      <div class="spacer"></div>
      <div class="btnbar">
        <button id="btnAddPage" class="btn">+ í˜ì´ì§€ ì¶”ê°€</button>
        <button id="btnDelPage" class="btn">- í˜ì´ì§€ ì œê±°</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* -------------------- ìƒíƒœ -------------------- */
  var MODE = (new URL(location.href).searchParams.get('mode')||'write').toLowerCase()==='ai' ? 'ai' : 'direct';
  var MAX_PAGES = 5;
  var DEFAULT_COUNT = 3;

  var el = {
    title: document.getElementById('titleInput'),
    pageCount: document.getElementById('pageCountInput'),
    pagesWrap: document.getElementById('pagesWrap'),
    btnAdd: document.getElementById('btnAddPage'),
    btnDel: document.getElementById('btnDelPage'),
    keyword: document.getElementById('keywordInput'),
    autoAdjust: document.getElementById('autoAdjustChk'),
    btnAiPlot: document.getElementById('btnAiPlot'),
    btnPrev: document.getElementById('btnPrev'),
    btnHome: document.getElementById('btnHome'),
    btnSave: document.getElementById('btnSave'),
    btnToImages: document.getElementById('btnToImages'),
    btnToggleMode: document.getElementById('btnToggleMode'),
    modePill: document.getElementById('modePill')
  };


    /* -------------------- ìƒíƒœ -------------------- */
  var MODE = 'direct'; // 'direct' | 'ai'
  var MAX_PAGES = 5;
  var DEFAULT_COUNT = 3;

  var el = {
    title: document.getElementById('titleInput'),
    pageCount: document.getElementById('pageCountInput'),
    pagesWrap: document.getElementById('pagesWrap'),
    btnAdd: document.getElementById('btnAddPage'),
    btnDel: document.getElementById('btnDelPage'),
    keyword: document.getElementById('keywordInput'),
    autoAdjust: document.getElementById('autoAdjustChk'),
    btnAiPlot: document.getElementById('btnAiPlot'),
    btnPrev: document.getElementById('btnPrev'),
    btnHome: document.getElementById('btnHome'),
    btnSave: document.getElementById('btnSave'),
    btnToImages: document.getElementById('btnToImages'),
    btnToggleMode: document.getElementById('btnToggleMode'),
    modePill: document.getElementById('modePill')
  };

  /* âœ… URL íŒŒë¼ë¯¸í„°ë¡œ ëª¨ë“œ ê°•ì œ */
  (function initModeFromQuery(){
    var q = new URLSearchParams(location.search);
    var m = (q.get('mode')||'').toLowerCase();
    if (m === 'ai') MODE = 'ai'; else MODE = 'direct';
    // UI ë°˜ì˜
    if (MODE === 'ai'){
      el.btnToggleMode.textContent = 'ì§ì ‘ì“°ê¸°';
      el.modePill.textContent = 'AIì™€ í•¨ê»˜ ì“°ê¸°';
    } else {
      el.btnToggleMode.textContent = 'AIì™€ í•¨ê»˜ ì“°ê¸°';
      el.modePill.textContent = 'ì§ì ‘ ì“°ê¸°';
    }
  })();


  /* -------------------- ìœ í‹¸ -------------------- */
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function stripLeadingNumber(s){
    if (!s) return "";
    return String(s).replace(/^\s*\d+[\.\)]\s*/, "");
  }
  function getPageCount(){ return clamp(parseInt(el.pageCount.value||DEFAULT_COUNT,10)||DEFAULT_COUNT, 1, MAX_PAGES); }
  function getPages(){
    var areas = Array.prototype.slice.call(el.pagesWrap.querySelectorAll('textarea'));
    return areas.map(function(t){ return (t.value||'').trim(); });
  }
  function setPages(pages){
    var count = clamp(pages.length, 1, MAX_PAGES);
    el.pageCount.value = count;
    renderPageAreas(count, pages);
  }
  function renderPageAreas(count, preset){
    el.pagesWrap.innerHTML = '';
    for (var i=0;i<count;i++){
      var box = document.createElement('div');
      box.className = 'page-box';
      var idx = i+1;
      var label = document.createElement('div');
      label.className = 'page-title';
      label.textContent = 'í˜ì´ì§€ ' + idx;

      var ta = document.createElement('textarea');
      ta.placeholder = 'ì´ í˜ì´ì§€ì˜ í•œ ì¤„ ë¬¸ì¥(ì§§ê²Œ)';
      ta.value = (preset && preset[i]) ? stripLeadingNumber(preset[i]) : '';

      box.appendChild(label);
      box.appendChild(ta);
      el.pagesWrap.appendChild(box);
    }
  }
  function toast(msg){ try{ alert(msg); }catch(e){} }

  /* -------------------- ì´ˆê¸° -------------------- */
  (function init(){
    // ëª¨ë“œ ë°°ì§€
    if (MODE === 'ai') {
      el.btnToggleMode.textContent = 'ì§ì ‘ì“°ê¸°';
      el.modePill.textContent = 'AIì™€ í•¨ê»˜ ì“°ê¸°';
    }

    // ì„ì‹œ ì €ì¥ ë³µêµ¬
    try {
      var saved = JSON.parse(localStorage.getItem('story_draft')||'{}');
      if (saved && Array.isArray(saved.pages) && saved.pages.length){
        el.title.value = saved.title || '';
        var cnt = clamp(saved.pages.length, 1, MAX_PAGES);
        el.pageCount.value = cnt;
        renderPageAreas(cnt, saved.pages);
        return;
      }
    }catch(e){}
    // ê¸°ë³¸
    el.pageCount.value = DEFAULT_COUNT;
    renderPageAreas(DEFAULT_COUNT, []);
  })();

  /* -------------------- ì´ë²¤íŠ¸ -------------------- */
  el.pageCount.addEventListener('change', function(){
    var cnt = getPageCount();
    var current = getPages();
    if (current.length < cnt){ while(current.length < cnt) current.push(''); }
    else if (current.length > cnt){ current = current.slice(0, cnt); }
    renderPageAreas(cnt, current);
  });

  el.btnAdd.addEventListener('click', function(){
    var cnt = getPageCount();
    if (cnt >= MAX_PAGES) return toast('ìµœëŒ€ '+MAX_PAGES+' í˜ì´ì§€ì…ë‹ˆë‹¤.');
    var pages = getPages(); pages.push(''); setPages(pages);
  });

  el.btnDel.addEventListener('click', function(){
    var cnt = getPageCount();
    if (cnt <= 1) return toast('ìµœì†Œ 1í˜ì´ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    var pages = getPages(); pages.pop(); setPages(pages);
  });

  // ëª¨ë“œ í† ê¸€
  el.btnToggleMode.addEventListener('click', function(){
    MODE = (MODE === 'direct') ? 'ai' : 'direct';
    if (MODE === 'ai'){ el.btnToggleMode.textContent = 'ì§ì ‘ì“°ê¸°'; el.modePill.textContent = 'AIì™€ í•¨ê»˜ ì“°ê¸°'; }
    else { el.btnToggleMode.textContent = 'AIì™€ í•¨ê»˜ ì“°ê¸°'; el.modePill.textContent = 'ì§ì ‘ ì“°ê¸°'; }
  });

  // ì„ì‹œ ì €ì¥
  el.btnSave.addEventListener('click', function(){
    var draft = { title: el.title.value || '', pages: getPages() };
    localStorage.setItem('story_draft', JSON.stringify(draft));
    toast('ì„ì‹œ ì €ì¥ ì™„ë£Œ');
  });

  // ì´ì „/ëŒ€ì‹œë³´ë“œ
  el.btnPrev.addEventListener('click', function(){ history.back(); });
  el.btnHome.addEventListener('click', function(){ location.href = '/dashboard'; });

  /* -------------------- AI ì¶”ì²œ (ëª©ì—…) -------------------- */
  el.btnAiPlot.addEventListener('click', async function(){
    var kws = (el.keyword.value || '').split(',').map(k => k.trim()).filter(Boolean);
    if (!kws.length) return toast('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    var count = getPageCount();
    if (el.autoAdjust.checked){ count = clamp(kws.length, 1, MAX_PAGES); el.pageCount.value = count; }

    var pages = [];
    for (var i=0;i<count;i++){
      var w = kws[i] || ('ì¥ë©´ ' + (i+1));
      pages.push('â€˜'+ w +'â€™ì„ ì£¼ì œë¡œ í•œ ì¥ë©´.');
    }
    setPages(pages);
  });

  /* -------------------- ì´ë¯¸ì§€ í˜ì´ì§€ë¡œ ì´ë™(ì„¸ì…˜ ìºì‹œ) -------------------- */
  function collectForImages(){
    var pages = getPages();
    var cnt = clamp(pages.length, 1, MAX_PAGES);
    if (cnt !== getPageCount()) el.pageCount.value = cnt;
    return { title: el.title.value || '', pages, count: cnt };
  }

  async function goImages(){
    var data = collectForImages();

    // 1) ì„¸ì…˜ ì €ì¥
    const res = await fetch('/editor/cache', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    if (!res.ok) { toast('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨'); return; }

    // 2) ì´ë™
    location.href = '/images';
  }

  // â€œì´ë¯¸ì§€ ìƒì„±â€ ë²„íŠ¼ì— í›„í‚¹
  el.btnToImages.addEventListener('click', function(e){ e.preventDefault(); goImages(); });

})();
</script>
</body>
</html>