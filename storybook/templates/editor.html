<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê¸€ í¸ì§‘</title>
  <style>
    :root {
      --gap: 24px;
      --brand: #2563eb;
      --muted: #6b7280;
    }

    body {
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f7f9fb;
      color:#111827;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      font-size: 24px;
      margin: 0 0 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 28px;
    }

    .panel {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 18px;
    }

    .panel h2 {
      font-size: 16px;
      margin: 0 0 12px;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    label {
      display: block;
      font-size: 13px;
      color: #374151;
      margin: 10px 0 6px;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: #fff;
    }

    textarea {
      height: 120px;
      resize: vertical;
    }

    .btnbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid #d1d5db;
      background: #f8f9fb;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color .15s ease, box-shadow .15s ease, transform .05s ease;
    }

    .btn:disabled {
      opacity: .5;
      cursor: default;
      box-shadow: none;
    }

    .btn:not(:disabled):active {
      transform: translateY(1px);
    }

    .btn.primary {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    .btn.ghost {
      background: #fff;
    }

    .btn.success {
      background: #10b981;
      color: #fff;
      border-color: #10b981;
    }

    .btn.warn {
      background: #f59e0b;
      color: #fff;
      border-color: #f59e0b;
    }

    .pages {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .page-box {
      border: 1px dashed #e5e7eb;
      border-radius: 12px;
      padding: 14px;
    }

    .page-title {
      font-weight: 600;
      margin-bottom: 8px;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .spacer {
      height: 10px;
    }

    .page-meta-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
      font-size:13px;
    }
    .page-keywords-label{
      color:#6b7280;
      font-size:13px;
      flex-shrink:0;
    }
    .page-keywords-input{
      flex:1;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #e5e7eb;
      font-size:13px;
    }
    .page-tools-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      gap:8px;
      flex-wrap:wrap;
    }
    /* í˜ì´ì§€ë³„ 'ì´ì „ ì´ì•¼ê¸° ì´ì–´ê°€ê¸°' ë¼ë²¨ì€ ë‹¹ë¶„ê°„ UIì—ì„œ ìˆ¨ê¹€ */
    .page-continue-label{
      /*display:flex;*/
      display: none !important;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:#6b7280;
    }
    .page-tools-row .page-ai-btn{
      font-size:12px;
      padding:6px 10px;
    }

    .mode-pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 13px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ğŸ“ ê¸€ í¸ì§‘ <span id="modePill" class="mode-pill">ì§ì ‘ ì“°ê¸°</span></h1>

    <div class="grid">
      <!-- ì¢Œì¸¡: ê¸°ë³¸ ì •ë³´ + AI ì¶”ì²œ ë°›ê¸° -->
      <div class="panel">
        <h2>ê¸°ë³¸ ì •ë³´</h2>

        <label>ì œëª©</label>
        <input id="titleInput" type="text" placeholder="ì˜ˆ: ì§€í™˜ì´ì˜ ëª¨í—˜ ì¼ê¸°" />

        <div class="row">
          <div style="flex:1">
            <label>í˜ì´ì§€ ìˆ˜ (1~5)</label>
            <input id="pageCountInput" type="number" min="1" max="5" value="3" />
            <div class="muted">í˜ì´ì§€ ìˆ˜ë¥¼ ë°”ê¾¸ë©´ í¸ì§‘ ì˜ì—­ì´ ìë™ìœ¼ë¡œ ë§ì¶°ì§‘ë‹ˆë‹¤.</div>
          </div>
        </div>

        <div class="spacer"></div>
        <hr style="border:none;border-top:1px solid #eee;" />
        <div class="spacer"></div>

        <section id="aiSection">
              <h2>AI ì¶”ì²œ ë°›ê¸° <span class="muted" style="font-weight:400;font-size:12px">AIì™€ í•¨ê»˜ ì“°ê¸° ëª¨ë“œì—ì„œ ì‚¬ìš© ê¶Œì¥</span></h2>

              <!-- ìŠ¤í† ë¦¬ ì „ì²´ ë©”íƒ€ ì •ë³´ -->
              <div class="spacer"></div>
              <div style="flex-direction:column; gap:8px">
                <div>
                  <label>ì¥ë¥´</label>
                  <input id="metaGenre" type="text" placeholder="ì˜ˆ: ëª¨í—˜, ì„±ì¥, ìš°ì •">
                </div>
                <div>
                  <label>ë°°ê²½</label>
                  <input id="metaWorld" type="text" placeholder="ì˜ˆ: ìš°ì£¼, ìˆ²ì† ë§ˆì„, ë°”ë‹·ì† ì™•êµ­">
                </div>
                <div>
                  <label>ì£¼ì œ</label>
                  <input id="metaTheme" type="text" placeholder="ì˜ˆ: ìš©ê¸°, ê°€ì¡±, ë„ì „">
                </div>
                <div>
                  <label>ì£¼ì¸ê³µ</label>
                  <input id="metaHero" type="text" placeholder="ì˜ˆ: ì†Œë…„ ì¼€ë¹ˆ, ê³ ì–‘ì´ ë£¨ë‚˜">
                </div>
              </div>

              <div class="spacer"></div>
              <div class="muted" style="font-size:12px">
                ìœ„ ì •ë³´ëŠ” ì „ì²´ ìŠ¤í† ë¦¬ì˜ ë¼ˆëŒ€(ì¥ë¥´/ë°°ê²½/ì£¼ì œ/ì£¼ì¸ê³µ)ë¥¼ ë§Œë“¤ ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.<br/>
                í˜ì´ì§€ë³„ë¡œëŠ” ì˜¤ë¥¸ìª½ì—ì„œ ê°œë³„ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.
              </div>

              <div class="spacer"></div>

              <div class="row" style="margin-top:8px">
                <label style="display:flex; align-items:center; gap:8px; margin:0">
                  <input id="autoAdjustChk" type="checkbox" checked/>
                  í‚¤ì›Œë“œ/í˜ì´ì§€ ê°œìˆ˜ì— ë§ì¶° í˜ì´ì§€ ìˆ˜ ìë™ ì¡°ì •
                </label>
                <span class="muted">(ìµœëŒ€ 5í˜ì´ì§€)</span>
              </div>

              <div class="spacer"></div>
              <button id="btnAiPlot" class="btn primary" style="width:100%">AIë¡œ ì¶”ì²œ í”Œë¡¯ ìƒì„±</button>

              <div class="spacer"></div>
              <div class="muted">â€» í˜„ì¬ëŠ” ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. (í–¥í›„ Gemini/LLM ì—°ë™ ì˜ˆì •)</div>

              <div class="spacer"></div>
              <hr style="border:none;border-top:1px solid #eee;"/>
              <div class="spacer"></div>
        </section>


        <div class="btnbar">
          <!-- 1ì¤„: ì´ì „/ëŒ€ì‹œë³´ë“œ/ì„ì‹œ ì €ì¥ -->
          <button id="btnPrev" class="btn ghost">ì´ì „í˜ì´ì§€</button>
          <button id="btnHome" class="btn ghost">ëŒ€ì‹œë³´ë“œ</button>
          <button id="btnSave" class="btn warn">ì„ì‹œ ì €ì¥</button>
        </div>

        <div class="spacer"></div>
        <div class="btnbar">
          <!-- 2ì¤„: ëª¨ë“œ í† ê¸€ + ì´ë¯¸ì§€ ìƒì„± -->
          <button id="btnToggleMode" class="btn">AIì™€ í•¨ê»˜ ì“°ê¸°</button>
          <button id="btnToImages" class="btn success" data-action="to-images">ì´ë¯¸ì§€ ìƒì„±</button>
        </div>
      </div>

      <!-- ìš°ì¸¡: í˜ì´ì§€ë³„ ë¬¸ì¥ -->
      <div class="panel">
        <h2>í˜ì´ì§€ë³„ ë¬¸ì¥</h2>
        <div id="pagesWrap" class="pages"></div>

        <div class="spacer"></div>
        <div class="btnbar">
          <button id="btnAddPage" class="btn">+ í˜ì´ì§€ ì¶”ê°€</button>
          <button id="btnDelPage" class="btn">- í˜ì´ì§€ ì œê±°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      /* -------------------- ìƒíƒœ -------------------- */
      // URL íŒŒë¼ë¯¸í„°ë¡œ ëª¨ë“œ ê²°ì •: ?mode=ai â†’ 'ai', ê·¸ ì™¸ëŠ” 'direct'
      var MODE = (new URL(location.href).searchParams.get('mode') || 'write').toLowerCase() === 'ai' ? 'ai' : 'direct';
      var MAX_PAGES = 5;
      var DEFAULT_COUNT = 3;

    var el = {
      title: document.getElementById('titleInput'),
      pageCount: document.getElementById('pageCountInput'),
      pagesWrap: document.getElementById('pagesWrap'),
      btnAdd: document.getElementById('btnAddPage'),
      btnDel: document.getElementById('btnDelPage'),
      metaGenre: document.getElementById('metaGenre'),
      metaWorld: document.getElementById('metaWorld'),
      metaTheme: document.getElementById('metaTheme'),
      metaHero: document.getElementById('metaHero'),
      autoAdjust: document.getElementById('autoAdjustChk'),
      btnAiPlot: document.getElementById('btnAiPlot'),
      btnPrev: document.getElementById('btnPrev'),
      btnHome: document.getElementById('btnHome'),
      btnSave: document.getElementById('btnSave'),
      btnToImages: document.getElementById('btnToImages'),
      btnToggleMode: document.getElementById('btnToggleMode'),
      modePill: document.getElementById('modePill')
    };


      /* -------------------- ìœ í‹¸ -------------------- */

    function getStoryMetaForApi(){
      return {
        title: (el.title.value || '').trim(),
        genre: (document.getElementById('metaGenre')?.value || '').trim(),
        world: (document.getElementById('metaWorld')?.value || '').trim(),
        theme: (document.getElementById('metaTheme')?.value || '').trim(),
        hero: (document.getElementById('metaHero')?.value || '').trim()
      };
    }

    function getPageStateForApi(idx){
      var areas = Array.prototype.slice.call(
        el.pagesWrap.querySelectorAll('textarea')
      );
      var kwInputs = Array.prototype.slice.call(
        el.pagesWrap.querySelectorAll('.page-keywords-input')
      );

      var text = (areas[idx]?.value || '').trim();
      var kwStr = (kwInputs[idx]?.value || '').trim();
      var keywords = kwStr
        ? kwStr.split(',').map(function(k){ return k.trim(); }).filter(Boolean)
        : [];

      // ë‹¹ë¶„ê°„ì€ í•­ìƒ "ì´ì „ ì´ì•¼ê¸° ì´ì–´ê°€ê¸°"ê°€ ì¼œì ¸ ìˆë‹¤ê³  ê°„ì£¼í•˜ê³ ,
      // ì´ì „ í…ìŠ¤íŠ¸ëŠ” LLM ëª©ì—…ì—ì„œ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹„ì›Œë‘ .
      return {
        index: idx,
        text: text,
        keywords: keywords,
        continue: true,
        previous_text: ''
      };
    }


    async function callPlotApi(payload){
      var res = await fetch('/api/plot/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok){
        throw new Error('AI í”Œë¡¯ ìƒì„± ìš”ì²­ ì‹¤íŒ¨: ' + res.status);
      }
      return res.json();
    }

    function applyPlotResult(pages){
      var areas = Array.prototype.slice.call(
        el.pagesWrap.querySelectorAll('textarea')
      );
      (pages || []).forEach(function(p){
        var idx = p.index || 0;
        if (areas[idx]) {
          areas[idx].value = p.text || '';
        }
      });
    }


    function getStoryMeta(){
      return {
        genre: (el.metaGenre.value || '').trim(),
        world: (el.metaWorld.value || '').trim(),
        theme: (el.metaTheme.value || '').trim(),
        hero: (el.metaHero.value || '').trim()
      };
    }

    function getPageKeywordStrings(){
      var inputs = Array.prototype.slice.call(
        el.pagesWrap.querySelectorAll('.page-keywords-input')
      );
      return inputs.map(function(input){
        return (input.value || '').trim();
      });
    }

    function parseKeywords(str){
      if (!str) return [];
      return str.split(',').map(function(k){ return k.trim(); }).filter(Boolean);
    }

    function getContinueFlags(count){
      var checks = Array.prototype.slice.call(
        el.pagesWrap.querySelectorAll('.page-continue-chk')
      );
      var flags = [];
      for (var i=0;i<count;i++){
        flags[i] = checks[i] ? !!checks[i].checked : true;
      }
      return flags;
    }

    function getStageTexts(){
      return [
        'ì´ì•¼ê¸°ê°€ ì‹œì‘ë˜ëŠ” ì¥ë©´ì´ì—ìš”.',
        'ëª¨í—˜ì´ ë³¸ê²©ì ìœ¼ë¡œ í¼ì³ì§€ëŠ” ì¥ë©´ì´ì—ìš”.',
        'ëœ»ë°–ì˜ ì‚¬ê±´ì´ ì¼ì–´ë‚˜ëŠ” ì¥ë©´ì´ì—ìš”.',
        'ê°€ì¥ ê¸´ì¥ë˜ëŠ” í´ë¼ì´ë§¥ìŠ¤ ì¥ë©´ì´ì—ìš”.',
        'ë”°ëœ»í•˜ê²Œ ë§ˆë¬´ë¦¬ë˜ëŠ” ì¥ë©´ì´ì—ìš”.'
      ];
    }

    // í•œ í˜ì´ì§€ ë¬¸ì¥ì„ ë§Œë“œëŠ” ì‘ì€ ì—”ì§„
    function makePageSentence(idx, totalCount, meta, pageKwStrs, existingPages, stageTexts, flags){
      var hero = meta.hero || 'ì£¼ì¸ê³µ';
      var baseKeywords = [];
      if (meta.genre) baseKeywords.push(meta.genre);
      if (meta.world) baseKeywords.push(meta.world);
      if (meta.theme) baseKeywords.push(meta.theme);

      var pageKws = parseKeywords(pageKwStrs[idx] || '');
      var focus = pageKws[0] || baseKeywords[0] || ('ì¥ë©´ ' + (idx+1));

      var stageIndex;
      if (totalCount === 1){
        stageIndex = 0;
      } else {
        stageIndex = Math.round((idx / (totalCount - 1)) * (stageTexts.length - 1));
      }
      stageIndex = clamp(stageIndex, 0, stageTexts.length - 1);

      var prevText = (idx > 0 && flags[idx]) ? (existingPages[idx-1] || '') : '';
      var sentence = '';

      if (idx === 0){
        sentence = 'â€˜' + hero + 'â€™ì˜ ì´ì•¼ê¸°ì—ì„œ, â€˜' + focus + 'â€™ì„(ë¥¼) ì¤‘ì‹¬ìœ¼ë¡œ, ' + stageTexts[stageIndex];
      } else {
        if (prevText && flags[idx]){
          sentence = 'ì´ì „ ì¥ë©´ì„ ì´ì–´, â€˜' + focus + 'â€™ì„(ë¥¼) ì¤‘ì‹¬ìœ¼ë¡œ, ' + stageTexts[stageIndex];
        } else {
          sentence = 'â€˜' + focus + 'â€™ì„(ë¥¼) ì¤‘ì‹¬ìœ¼ë¡œ, ' + stageTexts[stageIndex];
        }
      }

      return sentence;
    }


      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
      function stripLeadingNumber(s) {
        if (!s) return "";
        return String(s).replace(/^\s*\d+[\.\)]\s*/, "");
      }
      function getPageCount() { return clamp(parseInt(el.pageCount.value || DEFAULT_COUNT, 10) || DEFAULT_COUNT, 1, MAX_PAGES); }
      function getPages() {
        var areas = Array.prototype.slice.call(el.pagesWrap.querySelectorAll('textarea'));
        return areas.map(function (t) { return (t.value || '').trim(); });
      }
      function setPages(pages) {
        var count = clamp(pages.length, 1, MAX_PAGES);
        el.pageCount.value = count;
        renderPageAreas(count, pages);
      }
    function renderPageAreas(count, preset){
      el.pagesWrap.innerHTML = '';
      for (var i=0;i<count;i++){
        var box = document.createElement('div');
        box.className = 'page-box';
        var idx = i+1;

        // ì œëª©
        var label = document.createElement('div');
        label.className = 'page-title';
        label.textContent = 'í˜ì´ì§€ ' + idx;

        // í˜ì´ì§€ í‚¤ì›Œë“œ ì…ë ¥
        var metaRow = document.createElement('div');
        metaRow.className = 'page-meta-row';

        var kwLabel = document.createElement('span');
        kwLabel.className = 'page-keywords-label';
        kwLabel.textContent = 'í‚¤ì›Œë“œ';

        var kwInput = document.createElement('input');
        kwInput.type = 'text';
        kwInput.className = 'page-keywords-input';
        kwInput.placeholder = 'ì˜ˆ: ë¡œì¼“, ë°œì‚¬ì¥, ìƒˆë²½';
        kwInput.setAttribute('data-index', i);

        metaRow.appendChild(kwLabel);
        metaRow.appendChild(kwInput);

        // í…ìŠ¤íŠ¸ ì˜ì—­
        var ta = document.createElement('textarea');
        ta.placeholder = 'ì´ í˜ì´ì§€ì˜ í•œ ì¤„ ë¬¸ì¥(ì§§ê²Œ)';
        ta.value = (preset && preset[i]) ? stripLeadingNumber(preset[i]) : '';

        // í˜ì´ì§€ ë„êµ¬: ì´ì–´ì“°ê¸° + ê°œë³„ ì¬ìƒì„± ë²„íŠ¼
        var toolsRow = document.createElement('div');
        toolsRow.className = 'page-tools-row';

        var contLabel = document.createElement('label');
        contLabel.className = 'page-continue-label';

        var contChk = document.createElement('input');
        contChk.type = 'checkbox';
        contChk.className = 'page-continue-chk';
        contChk.checked = true;
        contChk.setAttribute('data-index', i);

        contLabel.appendChild(contChk);
        contLabel.appendChild(document.createTextNode(' ì´ì „ ì´ì•¼ê¸° ì´ì–´ê°€ê¸°'));

        var reBtn = document.createElement('button');
        reBtn.type = 'button';
        reBtn.className = 'btn page-ai-btn';
        reBtn.textContent = 'ì´ í˜ì´ì§€ë§Œ AIë¡œ ë‹¤ì‹œ ì“°ê¸°';
        reBtn.setAttribute('data-index', i);

        toolsRow.appendChild(contLabel);
        toolsRow.appendChild(reBtn);

        // ì¡°ë¦½
        box.appendChild(label);
        box.appendChild(metaRow);
        box.appendChild(ta);
        box.appendChild(toolsRow);

        el.pagesWrap.appendChild(box);
      }
    }

      function toast(msg) { try { alert(msg); } catch (e) { } }

      /* -------------------- ëª¨ë“œ UI ë°˜ì˜ -------------------- */
      function applyModeUI() {
        var aiSection = document.getElementById('aiSection');

        if (MODE === 'ai') {
          // ë¼ë²¨
          el.btnToggleMode.textContent = 'ì§ì ‘ì“°ê¸°';
          el.modePill.textContent = 'AIì™€ í•¨ê»˜ ì“°ê¸°';
          // AI ì„¹ì…˜ í‘œì‹œ
          if (aiSection) {
            aiSection.classList.remove('hidden');
            aiSection.setAttribute('aria-hidden', 'false');
          }
        } else {
          // ë¼ë²¨
          el.btnToggleMode.textContent = 'AIì™€ í•¨ê»˜ ì“°ê¸°';
          el.modePill.textContent = 'ì§ì ‘ ì“°ê¸°';
          // AI ì„¹ì…˜ ìˆ¨ê¹€
          if (aiSection) {
            aiSection.classList.add('hidden');
            aiSection.setAttribute('aria-hidden', 'true');
          }
        }
      }

      /* -------------------- ì´ˆê¸° -------------------- */
      (function init() {
        applyModeUI();

        // ì„ì‹œ ì €ì¥ ë³µêµ¬
        try {
          var saved = JSON.parse(localStorage.getItem('story_draft') || '{}');
          if (saved && Array.isArray(saved.pages) && saved.pages.length) {
            el.title.value = saved.title || '';
            var cnt = clamp(saved.pages.length, 1, MAX_PAGES);
            el.pageCount.value = cnt;
            renderPageAreas(cnt, saved.pages);
            return;
          }
        } catch (e) { }
        // ê¸°ë³¸
        el.pageCount.value = DEFAULT_COUNT;
        renderPageAreas(DEFAULT_COUNT, []);
      })();

        // ê° í˜ì´ì§€ì—ì„œ "ì´ í˜ì´ì§€ë§Œ AIë¡œ ë‹¤ì‹œ ì“°ê¸°" ë²„íŠ¼
      el.pagesWrap.addEventListener('click', async function(e){
        var target = e.target;
        if (!target.classList.contains('page-ai-btn')) return;

        var idx = parseInt(target.getAttribute('data-index') || '0', 10);
        if (isNaN(idx)) idx = 0;

        try {
          var meta = getStoryMetaForApi();
          var page = getPageStateForApi(idx);
          var payload = { meta: meta, pages: [page] };
          var resp = await callPlotApi(payload);
          if (resp && resp.pages && resp.pages.length){
            applyPlotResult(resp.pages);
          }
        } catch (err){
          console.error(err);
          alert('í•´ë‹¹ í˜ì´ì§€ AI ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });




      /* -------------------- ì´ë²¤íŠ¸ -------------------- */
      el.pageCount.addEventListener('change', function () {
        var cnt = getPageCount();
        var current = getPages();
        if (current.length < cnt) { while (current.length < cnt) current.push(''); }
        else if (current.length > cnt) { current = current.slice(0, cnt); }
        renderPageAreas(cnt, current);
      });

      el.btnAdd.addEventListener('click', function () {
        var cnt = getPageCount();
        if (cnt >= MAX_PAGES) return toast('ìµœëŒ€ ' + MAX_PAGES + ' í˜ì´ì§€ì…ë‹ˆë‹¤.');
        var pages = getPages(); pages.push(''); setPages(pages);
      });

      el.btnDel.addEventListener('click', function () {
        var cnt = getPageCount();
        if (cnt <= 1) return toast('ìµœì†Œ 1í˜ì´ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        var pages = getPages(); pages.pop(); setPages(pages);
      });

      // ëª¨ë“œ í† ê¸€
      el.btnToggleMode.addEventListener('click', function () {
        MODE = (MODE === 'direct') ? 'ai' : 'direct';
        applyModeUI();
      });

      // ì„ì‹œ ì €ì¥
      el.btnSave.addEventListener('click', function () {
        var draft = { title: el.title.value || '', pages: getPages() };
        localStorage.setItem('story_draft', JSON.stringify(draft));
        toast('ì„ì‹œ ì €ì¥ ì™„ë£Œ');
      });

      // ì´ì „/ëŒ€ì‹œë³´ë“œ
      el.btnPrev.addEventListener('click', function () { history.back(); });
      el.btnHome.addEventListener('click', function () { location.href = '/dashboard'; });

       /* -------------------- AI ì¶”ì²œ (LLM Provider ê²½ìœ ) -------------------- */
      el.btnAiPlot.addEventListener('click', async function(){
        try {
          var count = getPageCount();
          var meta = getStoryMetaForApi();
          var pages = [];
          for (var i=0;i<count;i++){
            pages.push(getPageStateForApi(i));
          }
          var payload = { meta: meta, pages: pages };
          var resp = await callPlotApi(payload);
          if (resp && resp.pages){
            applyPlotResult(resp.pages);
          } else {
            alert('AI í”Œë¡¯ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          }
        } catch (err){
          console.error(err);
          alert('AI í”Œë¡¯ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” ë¡œê·¸ ì°¸ê³ )');
        }
      });


      /* -------------------- ì´ë¯¸ì§€ í˜ì´ì§€ë¡œ ì´ë™(ì„¸ì…˜ ìºì‹œ) -------------------- */
      function collectForImages() {
        var pages = getPages();
        var cnt = clamp(pages.length, 1, MAX_PAGES);
        if (cnt !== getPageCount()) el.pageCount.value = cnt;
        return { title: el.title.value || '', pages, count: cnt };
      }

      async function goImages() {
        var data = collectForImages();

        // 1) ì„¸ì…˜ ì €ì¥
        const res = await fetch('/editor/cache', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) { toast('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨'); return; }

        // 2) ì´ë™
        location.href = '/images';
      }

      el.btnToImages.addEventListener('click', function (e) { e.preventDefault(); goImages(); });
    })();
  </script>
</body>

</html>