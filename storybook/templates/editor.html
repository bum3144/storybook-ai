<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê¸€ í¸ì§‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#2f67ff;
      --ink:#0b1220;
      --sub:#5d667b;
      --bg:#f6f8fb;
      --card:#ffffff;
      --line:#e5e9f0;
      --green:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:32px;
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
      color:var(--ink); background:var(--bg);
    }
    h1{font-size:24px; margin:4px 0 24px;}
    .wrap{display:grid; grid-template-columns:360px 1fr; gap:24px;}
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:14px; padding:18px;
    }
    .section-title{font-weight:700; margin:2px 0 10px;}
    label{display:block; font-size:14px; color:var(--sub); margin-bottom:6px;}
    input[type="text"], input[type="number"], textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px;
      font-size:15px; background:#fff; outline:none;
    }
    textarea{min-height:110px; resize:vertical;}
    .hint{font-size:12px; color:var(--sub); margin-top:6px;}
    .row{display:flex; gap:10px; align-items:center;}
    .badge{font-size:12px; color:#fff; background:#7c3aed; padding:2px 7px; border-radius:999px;}
    .btn{
      display:inline-flex; justify-content:center; align-items:center; gap:8px;
      border-radius:10px; font-weight:700; cursor:pointer; border:1px solid var(--line);
      background:#fff; color:var(--ink); height:42px; padding:0 14px; user-select:none;
    }
    .btn.primary{background:var(--brand); color:#fff; border-color:var(--brand);}
    .btn.ghost{background:#fff;}
    .btn.success{background:var(--green); color:#fff; border-color:var(--green);}
    .btn:disabled{opacity:.5; cursor:not-allowed;}
    .list-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
    .pages{display:flex; flex-direction:column; gap:12px;}
    .pagebox{border:1px solid var(--line); border-radius:12px; padding:12px;}
    .pagebox h4{margin:0 0 8px; font-size:14px; color:var(--sub);}
    .toolbar{display:flex; gap:10px; margin-top:10px;}
    .divider{height:1px; background:var(--line); margin:14px 0;}
    .hidden{display:none !important;}

    /* í•˜ë‹¨ ë²„íŠ¼ 2ì¤„ ë ˆì´ì•„ì›ƒ */
    .footer{display:flex; flex-direction:column; gap:10px; margin-top:16px;}
    .footer-line{display:flex; gap:12px; flex-wrap:nowrap;}
    .footer-line .btn{flex:1 1 0;}
    .footer-line .btn.shrink{flex:0 0 auto;}
    @media (max-width:980px){
      .wrap{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <h1>ğŸ“ ê¸€ í¸ì§‘</h1>

  <div class="wrap">

    <!-- ì¢Œì¸¡: ê¸°ë³¸ ì •ë³´ + AI ì¶”ì²œ -->
    <div class="card">
      <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

      <div style="margin-bottom:14px;">
        <label for="title">ì œëª©</label>
        <input id="title" type="text" placeholder="ì˜ˆ: ì§€í™˜ì´ì˜ ëª¨í—˜ ì¼ê¸°" />
      </div>

      <div style="margin-bottom:14px;">
        <label for="pageCount">í˜ì´ì§€ ìˆ˜ (1~5)</label>
        <input id="pageCount" type="number" value="3" min="1" max="5" />
        <div class="hint">í˜ì´ì§€ ìˆ˜ë¥¼ ë°”ê¾¸ë©´ í¸ì§‘ ì˜ì—­ì´ ìë™ìœ¼ë¡œ ë§ì¶°ì§‘ë‹ˆë‹¤.</div>
      </div>

      <!-- AI ì¶”ì²œ: mode=ai ì¼ ë•Œë§Œ ë…¸ì¶œ -->
      <div id="aiSection" class="card" style="padding:14px; margin-top:10px;">
        <div class="row" style="margin-bottom:10px;">
          <div class="section-title" style="margin:0;">AI ì¶”ì²œ ë°›ê¸°</div>
          <span class="badge">AI</span>
        </div>
        <label for="keywords">í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <input id="keywords" type="text" placeholder="ì˜ˆ: ì”¨ì•—, ìˆ², ì¹œêµ¬" />
        <div class="row" style="margin:8px 0;">
          <input id="autoAdjust" type="checkbox" checked />
          <label for="autoAdjust" style="margin:0;">í‚¤ì›Œë“œ ê°œìˆ˜ì— ë§ì¶° í˜ì´ì§€ ìˆ˜ ìë™ ì¡°ì •</label>
        </div>
        <button id="btnAI" class="btn primary" style="width:100%;">AIë¡œ ì¶”ì²œ í”Œë¡¯ ìƒì„±</button>
        <div class="hint">ì§€ê¸ˆì€ ê°„ë‹¨í•œ ëª©ì—… ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹¤ì œ Gemini/Imagenì€ ë‹¤ìŒ ë‹¨ê³„ ì—°ë™.</div>
      </div>

      <!-- í•˜ë‹¨ ë²„íŠ¼ 2ì¤„ -->
      <div class="footer">
        <!-- 1ì¤„: [ì´ì „í˜ì´ì§€] [ëŒ€ì‹œë³´ë“œ] [ì„ì‹œ ì €ì¥] -->
        <div class="footer-line">
          <button id="btnBackPage" class="btn ghost">ì´ì „í˜ì´ì§€</button>
          <button id="btnBack" class="btn ghost">ëŒ€ì‹œë³´ë“œ</button>
          <button id="btnDraft" class="btn">ì„ì‹œ ì €ì¥</button>
        </div>
        <!-- 2ì¤„: [ëª¨ë“œ ì „í™˜] [ì´ë¯¸ì§€ ìƒì„±] -->
        <div class="footer-line">
          <button id="btnSwitchMode" class="btn"></button>
          <button id="btnToImages" class="btn success">ì´ë¯¸ì§€ ìƒì„±</button>
        </div>
      </div>
    </div>

    <!-- ìš°ì¸¡: í˜ì´ì§€ë³„ ë¬¸ì¥ -->
    <div class="card">
      <div class="list-head">
        <div class="section-title">í˜ì´ì§€ë³„ ë¬¸ì¥</div>
        <div class="toolbar">
          <button id="btnAdd" class="btn ghost shrink">+ í˜ì´ì§€ ì¶”ê°€</button>
          <button id="btnRemove" class="btn ghost shrink">- í˜ì´ì§€ ì œê±°</button>
        </div>
      </div>
      <div id="pages" class="pages"></div>
    </div>

  </div>

  <script>
    // ì¿¼ë¦¬ ì½ê¸°
    function getQuery(key){
      const u = new URL(location.href);
      return u.searchParams.get(key);
    }

    // ìƒíƒœ
    const state = {
      mode: getQuery('mode') || 'ai',   // 'write' | 'ai'
      maxPages: 5,
      title: '',
      pageCount: 3,
      lines: [],
    };

    // DOM
    const elTitle = document.getElementById('title');
    const elPageCount = document.getElementById('pageCount');
    const elPages = document.getElementById('pages');
    const elAISection = document.getElementById('aiSection');
    const elKeywords = document.getElementById('keywords');
    const elAutoAdjust = document.getElementById('autoAdjust');

    const btnAI = document.getElementById('btnAI');
    const btnDraft = document.getElementById('btnDraft');
    const btnBack = document.getElementById('btnBack');
    const btnBackPage = document.getElementById('btnBackPage');
    const btnToImages = document.getElementById('btnToImages');
    const btnAdd = document.getElementById('btnAdd');
    const btnRemove = document.getElementById('btnRemove');
    const btnSwitchMode = document.getElementById('btnSwitchMode');

    // ëª¨ë“œ ë°˜ì˜ + ìŠ¤ìœ„ì¹˜ ë²„íŠ¼ í…ìŠ¤íŠ¸
    function applyMode(){
      if(state.mode === 'write'){
        elAISection.classList.add('hidden');
        btnSwitchMode.textContent = 'AIì™€ í•¨ê»˜ ì“°ê¸°';
      }else{
        elAISection.classList.remove('hidden');
        btnSwitchMode.textContent = 'ì§ì ‘ ì“°ê¸°';
      }
    }

    // URL ëª¨ë“œë„ í•¨ê»˜ ë°”ê¿”ì£¼ê¸°(ìƒˆë¡œê³ ì¹¨ ì—†ì´ íˆìŠ¤í† ë¦¬ êµì²´)
    function setMode(newMode){
      state.mode = newMode;
      applyMode();
      autosave(); // í˜„ì¬ ë‚´ìš© ê·¸ëŒ€ë¡œ ì €ì¥
      const url = new URL(location.href);
      url.searchParams.set('mode', newMode);
      history.replaceState(null, '', url.toString());
    }

    // í˜ì´ì§€ ë Œë”
    function renderPages(){
      elPages.innerHTML = '';
      const n = state.pageCount;
      while(state.lines.length < n) state.lines.push('');
      if(state.lines.length > n) state.lines = state.lines.slice(0, n);

      for(let i=0;i<n;i++){
        const box = document.createElement('div');
        box.className = 'pagebox';
        box.innerHTML = `
          <h4>í˜ì´ì§€ ${i+1}</h4>
          <textarea data-idx="${i}" placeholder="ì´ í˜ì´ì§€ì˜ í•œ ì¤„ ë¬¸ì¥(ì§§ê²Œ)">${state.lines[i] || ''}</textarea>
        `;
        elPages.appendChild(box);
      }
      elPages.querySelectorAll('textarea').forEach(t=>{
        t.addEventListener('input', (e)=>{
          const idx = +e.target.dataset.idx;
          state.lines[idx] = e.target.value;
          autosave();
        });
      });
    }

    // í˜ì´ì§€ ìˆ˜ ë™ê¸°í™”
    function syncPageCount(val){
      let n = parseInt(val || 1, 10);
      if(Number.isNaN(n)) n = 1;
      n = Math.max(1, Math.min(state.maxPages, n));
      state.pageCount = n;
      elPageCount.value = n;
      renderPages();
      autosave();
    }

    // ì„ì‹œ ì €ì¥
    const DRAFT_KEY = 'editor_draft_v1';
    function autosave(){
      const payload = {
        mode: state.mode,
        title: elTitle.value || '',
        pageCount: state.pageCount,
        lines: state.lines,
        keywords: elKeywords ? (elKeywords.value || '') : '',
      };
      try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(payload)); }catch(e){}
    }
    function restoreDraft(){
      try{
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        elTitle.value = data.title || '';
        state.pageCount = data.pageCount || 3;
        elPageCount.value = state.pageCount;
        state.lines = Array.isArray(data.lines) ? data.lines : [];
        if(elKeywords) elKeywords.value = data.keywords || '';
      }catch(e){}
    }

    // ì•Œë¦¼
    function toast(msg){ alert(msg); }

    // AI í”Œë¡¯ í˜¸ì¶œ
    async function callAI(){
      const kws = (elKeywords.value || '')
        .split(',').map(s=>s.trim()).filter(Boolean);

      if(elAutoAdjust && elAutoAdjust.checked && kws.length){
        syncPageCount(Math.min(kws.length, state.maxPages));
      }

      btnAI.disabled = true;
      try{
        const res = await fetch('/api/story',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ keywords:kws, pages: state.pageCount, withImages:false })
        });
        if(!res.ok) throw new Error('AI ìš”ì²­ ì‹¤íŒ¨');
        const data = await res.json();
        const clean = (data.pages||[]).map(line=>{
          const m = line.match(/^\s*\d+\.\s*(.*)$/);
          return m ? m[1] : line;
        });
        for(let i=0;i<state.pageCount;i++){
          state.lines[i] = clean[i] || state.lines[i] || '';
        }
        renderPages();
        autosave();
      }catch(e){
        toast('AI ì¶”ì²œ ìƒì„± ì‹¤íŒ¨');
      }finally{
        btnAI.disabled = false;
      }
    }

    // ì´ë¯¸ì§€ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
    function goImages(){
      const payload = {
        title: elTitle.value || 'ë§ì¶¤ ë™í™”(ì´ˆì•ˆ)',
        pages: state.lines.slice(0, state.pageCount),
        style: 'ë™í™” ì¼ëŸ¬ìŠ¤íŠ¸ (ê¸°ë³¸)',
      };
      try{ sessionStorage.setItem('editor_payload', JSON.stringify(payload)); }catch(e){}
      location.href = '/images';
    }

    // ì´ë²¤íŠ¸
    elTitle.addEventListener('input', autosave);
    elPageCount.addEventListener('input', (e)=> syncPageCount(e.target.value));
    btnDraft.addEventListener('click', ()=>{ autosave(); toast('ì„ì‹œ ì €ì¥ ì™„ë£Œ'); });
    btnBack.addEventListener('click', ()=> location.href = '/dashboard');
    btnBackPage.addEventListener('click', ()=> history.back());
    btnToImages.addEventListener('click', goImages);
    btnAdd.addEventListener('click', ()=>{ if(state.pageCount<state.maxPages) syncPageCount(state.pageCount+1); });
    btnRemove.addEventListener('click', ()=>{ if(state.pageCount>1) syncPageCount(state.pageCount-1); });
    btnAI && btnAI.addEventListener('click', callAI);
    btnSwitchMode.addEventListener('click', ()=>{
      const next = state.mode === 'write' ? 'ai' : 'write';
      setMode(next);
    });

    // ì´ˆê¸°í™”
    (function init(){
      restoreDraft();
      applyMode();
      syncPageCount(elPageCount.value || 3);
    })();
  </script>
</body>
</html>