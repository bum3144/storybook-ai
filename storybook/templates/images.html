<!-- storybook/templates/images.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì´ë¯¸ì§€ ìƒì„± Â· AI ê·¸ë¦¼ë™í™”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --txt:#111; --muted:#6b7280; --bg:#f7f9fa; --card:#ffffff; --line:#e5e7eb; --accent:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Helvetica,Arial;
      color:var(--txt); background:#fff;
    }
    header{display:flex; align-items:center; gap:12px; margin-bottom:20px}
    header a.back{color:var(--muted); text-decoration:none; border:1px solid var(--line); padding:6px 10px; border-radius:8px}
    h1{font-size:22px; margin:0}
    .desc{color:var(--muted); font-size:14px; margin-top:4px}

    .wrap{display:grid; grid-template-columns:1.25fr .75fr; gap:20px; align-items:start}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }

    .pane{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px}
    .pane h2{font-size:18px; margin:0 0 12px 0}
    .pages{display:flex; flex-direction:column; gap:10px}
    .page-row{display:flex; gap:10px; align-items:flex-start}
    .page-row small{color:var(--muted)}
    .page-text{
      flex:1; border:1px solid var(--line); border-radius:10px; padding:10px; min-height:44px; background:#fff;
      white-space:pre-wrap;
    }

    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 640px){ .grid{grid-template-columns:1fr} }
    .thumb{
      border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--bg);
      aspect-ratio: 1 / 1; display:flex; align-items:center; justify-content:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover}
    .empty{color:var(--muted); font-size:14px}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    button{
      border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px 14px; cursor:pointer;
      font-size:14px;
    }
    .primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .ghost{background:#fff}

    @media print {
      header, .toolbar{display:none !important}
      body{padding:0}
      .wrap{grid-template-columns:1fr}
      .pane{border:none}
    }
  </style>
</head>
<body>
  <header>
    <a class="back" href="/editor">â† ê¸€ í¸ì§‘ìœ¼ë¡œ</a>
    <div>
      <h1>ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„±</h1>
      <div class="desc">í˜ì´ì§€ë³„ ë¬¸ì¥ì„ ê¸°ë°˜ìœ¼ë¡œ ì¼ëŸ¬ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</div>
    </div>
  </header>

  <div class="wrap">
    <!-- Left: Image gallery -->
    <section class="pane">
      <h2 id="title">ì œëª©</h2>
      <div id="gallery" class="grid">
        <div class="empty">ì•„ì§ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.</div>
      </div>
      <div class="toolbar">
        <button id="btn-generate" class="primary">ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°</button>
        <button id="btn-save" class="ghost">í˜„ì¬ ìŠ¤í† ë¦¬ ì €ì¥(JSON)</button>
        <button id="btn-print" class="ghost">PDFë¡œ ì €ì¥(ì¸ì‡„)</button>
        <a href="/dashboard"><button class="ghost">ëŒ€ì‹œë³´ë“œë¡œ</button></a>
      </div>
    </section>

    <!-- Right: Page texts -->
    <aside class="pane">
      <h2>í˜ì´ì§€ë³„ ë¬¸ì¥</h2>
      <div id="pages" class="pages"></div>
    </aside>
  </div>

  <script>
    // ì„œë²„ì—ì„œ ì£¼ì…ëœ ê°’
    const rawTitle = {{ (title|tojson)|safe }};
    const pagesJson = {{ (pages_json|tojson)|safe }};

    // ìƒíƒœ
    let state = {
      title: rawTitle || "ë¬´ì œ",
      pages: [],
      images: []
    };

    // ì´ˆê¸° ë Œë”
    function initFromParams() {
      try {
        const parsed = JSON.parse(pagesJson || '[]');
        if (Array.isArray(parsed)) state.pages = parsed.map(x => String(x||'').trim());
      } catch(e){ state.pages = []; }
      if (!state.pages.length) state.pages = ["ì´ í˜ì´ì§€ì˜ í•œ ì¤„ ë¬¸ì¥(ì§§ê²Œ)"];
      document.getElementById('title').textContent = state.title;
      renderPages();
    }

    function renderPages() {
      const box = document.getElementById('pages');
      box.innerHTML = '';
      state.pages.forEach((line, idx) => {
        const row = document.createElement('div');
        row.className = 'page-row';
        row.innerHTML = `
          <small>${idx+1}.</small>
          <div class="page-text">${escapeHtml(line)}</div>
        `;
        box.appendChild(row);
      });
    }

    function renderImages() {
      const g = document.getElementById('gallery');
      g.innerHTML = '';
      if (!state.images.length) {
        g.innerHTML = '<div class="empty">ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.</div>';
        return;
      }
      state.images.forEach(url => {
        const d = document.createElement('div');
        d.className = 'thumb';
        d.innerHTML = `<img src="${url}" alt="">`;
        g.appendChild(d);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ê°„ë‹¨í•œ í‚¤ì›Œë“œ ì¶”ì¶œ(ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¡œ ì‚¬ìš©)
    function pagesToKeywords(pages){
      // ê° ë¬¸ì¥ì˜ í•µì‹¬ 1~8ë‹¨ì–´ ì •ë„ë¥¼ í”„ë¡¬í”„íŠ¸ë¡œ ì‚¬ìš©
      return pages.map(t => t.split(/\s+/).slice(0,8).join(' '));
    }

    // API í˜¸ì¶œë¡œ ì´ë¯¸ì§€ ìƒì„±
    async function generateImages(){
      const btn = document.getElementById('btn-generate');
      btn.disabled = true; btn.textContent = 'ìƒì„± ì¤‘...';
      try{
        const payload = {
          keywords: pagesToKeywords(state.pages),
          pages: state.pages.length,
          withImages: true
        };
        const res = await fetch('/api/story', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
        const data = await res.json();
        state.images = Array.isArray(data.images) ? data.images : [];
        renderImages();
      }catch(err){
        alert('ì˜¤ë¥˜: ' + err.message);
      }finally{
        btn.disabled = false; btn.textContent = 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°';
      }
    }

    async function saveJson(){
      const payload = {
        title: state.title,
        pages: state.pages,
        images: state.images
      };
      try{
        const res = await fetch('/api/story/save', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.saved) {
          alert('ì €ì¥ ì™„ë£Œ!\n' + (data.path || ''));
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨');
        }
      }catch(e){
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + e.message);
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.getElementById('btn-generate').addEventListener('click', generateImages);
    document.getElementById('btn-save').addEventListener('click', saveJson);
    document.getElementById('btn-print').addEventListener('click', () => window.print());

    // ì‹œì‘
    initFromParams();
    renderImages();
  </script>
</body>
</html>
