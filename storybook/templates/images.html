<!-- /storybook/templates/images.html -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ğŸŒ± ì´ë¯¸ì§€ ìƒì„±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#fafbfc; --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#2563eb; --primary-pressed:#1d4ed8; --border:#e5e7eb;
      --danger:#ef4444; --ok:#10b981;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif
    }

    .page{max-width:1180px;margin:24px auto;padding:0 16px}
    .title{font-size:22px;font-weight:700;margin:4px 0 18px 4px}

    .toolbar{width:360px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .row{display:grid;grid-template-columns:360px 1fr;gap:20px}

    .field{display:grid;gap:8px;margin-bottom:12px}
    .label{font-size:14px;color:var(--muted)}
    select,button{height:44px;border-radius:10px;border:1px solid var(--border);background:#fff;padding:0 12px;font-size:15px}
    .btn{cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff;border:none}
    .btn-primary:active{background:var(--primary-pressed)}
    .btn-outline{background:#fff}
    .btn-block{width:100%}
    .hint{font-size:12px;color:var(--muted);line-height:1.5;margin-top:10px}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media (max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.row{grid-template-columns:1fr}.grid{grid-template-columns:1fr}.toolbar{width:100%}}

    .card{border:1px solid var(--border);border-radius:12px;background:var(--card);display:flex;flex-direction:column;overflow:hidden}
    .figure{position:relative;width:100%;padding-top:125%;background:#f8fafc;border-bottom:1px solid var(--border)}

    /* ì´ë¯¸ì§€: ì™„ë£Œ ì‹œ í˜ì´ë“œì¸ */
    .figure>img{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      opacity:0;transition:opacity .25s ease
    }
    .figure>img.loaded{opacity:1}

    /* ì˜¤ë²„ë ˆì´: ê¸°ë³¸ í‘œì‹œ(ìƒì„± ì „ í…ìŠ¤íŠ¸), ë¡œë”© ì¤‘ì—ëŠ” ìŠ¤í”¼ë„ˆ ë³´ì„, ì™„ë£Œ(ready)ë©´ ìˆ¨ê¹€ */
    .figure .overlay{
      position:absolute;inset:0;background:rgba(255,255,255,.65);
      display:flex;align-items:center;justify-content:center;gap:8px;
      font-size:15px;color:var(--muted)
    }
    .figure .overlay .spinner{display:none}
    .figure.loading .overlay .spinner{display:inline-block}
    .figure.ready .overlay{display:none}

    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:2px solid #d1d5db;border-top-color:var(--primary);
      animation:spin .8s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .body{padding:12px;display:grid;gap:8px}
    .caption{font-size:14px;color:var(--text);min-height:20px}
    .controls{display:flex;align-items:center;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .pill input{width:16px;height:16px}
    .status.ok{color:var(--ok)} .status.danger{color:var(--danger)}
    .footer{margin-top:12px;display:flex;gap:10px}
    .btn-sm{height:36px;font-size:14px;padding:0 10px}
  </style>
</head>
<body>
  <div class="page">
    <div class="title">ğŸŒ± ì´ë¯¸ì§€ ìƒì„±</div>

    <div class="row">
      <!-- ì¢Œì¸¡ íˆ´ë°” -->
      <div class="toolbar">
        <div class="field">
          <div class="label">ìŠ¤íƒ€ì¼</div>
          <select id="style">
            <option {{ 'selected' if style == 'ë™í™” ì¼ëŸ¬ìŠ¤íŠ¸ (ê¸°ë³¸)' else '' }}>ë™í™” ì¼ëŸ¬ìŠ¤íŠ¸ (ê¸°ë³¸)</option>
            <option {{ 'selected' if style == 'ì—°í•„ ìŠ¤ì¼€ì¹˜' else '' }}>ì—°í•„ ìŠ¤ì¼€ì¹˜</option>
            <option {{ 'selected' if style == 'ìˆ˜ì±„í™” íŒŒìŠ¤í…”' else '' }}>ìˆ˜ì±„í™” íŒŒìŠ¤í…”</option>
          </select>
        </div>

        <div class="field"><button id="btnAll" class="btn btn-primary btn-block">ì „ì²´ ì´ë¯¸ì§€ ìƒì„±</button></div>
        <div class="field"><button id="btnPartial" class="btn btn-outline btn-block">ì„ íƒë§Œ ë‹¤ì‹œ ìƒì„±</button></div>
        <div class="field"><button id="btnBack" class="btn btn-outline btn-block">ê¸€ í¸ì§‘ìœ¼ë¡œ</button></div>
        <!-- ì¶”ê°€: ì™„ì„±ë³¸ ë³´ê¸° -->
        <div class="field"><button id="btnPreview" class="btn btn-outline btn-block" disabled>ì™„ì„±ë³¸ ë™í™” ë³´ê¸°</button></div>

        <p class="hint">
          í˜ì´ì§€ ìˆ˜ë§Œí¼ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì¹´ë“œ ìƒë‹¨ì€ ê¸°ë³¸ì ìœ¼ë¡œ <b>ìƒì„± ì „</b> ìƒíƒœì…ë‹ˆë‹¤.
          [ì „ì²´ ì´ë¯¸ì§€ ìƒì„±]ì„ ëˆ„ë¥´ë©´ ëª¨ë“  ì¹´ë“œê°€ ì¦‰ì‹œ <b>ìƒì„± ì¤‘â€¦</b>ìœ¼ë¡œ ë°”ë€Œê³ ,
          ë¡œë“œ ì™„ë£Œë˜ë©´ ì˜¤ë²„ë ˆì´ê°€ ì‚¬ë¼ì§€ë©° ì´ë¯¸ì§€ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
        </p>
      </div>

      <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
      <div class="grid" id="grid">
        {% for p in pages %}
        <div class="card" data-index="{{ p.index }}" data-text="{{ (p.text or '').replace('"','&quot;') }}">
          <div class="figure">
            <img alt="ì´ë¯¸ì§€ {{ p.index }}" />
            <div class="overlay">
              <div class="spinner"></div>
              <span data-overlay-text>ìƒì„± ì „</span>
            </div>
          </div>
          <div class="body">
            <div class="caption">{{ p.index }}. {{ p.text or 'ì¥ë©´ ì„¤ëª… ì—†ìŒ' }}</div>
            <div class="controls">
              <label class="pill"><input type="checkbox" class="ck" /> ì´ í˜ì´ì§€ ë‹¤ì‹œ ìƒì„±</label>
              <span class="pill status" data-status>ìƒì„± ì „</span>
            </div>
            <div class="footer">
              <button class="btn btn-outline btn-sm" data-action="retry">ë‹¤ì‹œ ìƒì„±</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

<script>
const grid = document.getElementById('grid');
const styleSel = document.getElementById('style');
const allBtn = document.getElementById('btnAll');
const partialBtn = document.getElementById('btnPartial');
const backBtn = document.getElementById('btnBack');
const previewBtn = document.getElementById('btnPreview');

const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const getCards = ()=> $$('.card', grid);

/* -------------------- ìƒíƒœ í‘œì‹œ -------------------- */
function setStatus(card, txt, cls){
  const st = card.querySelector('[data-status]');
  const overlayText = card.querySelector('[data-overlay-text]');
  if (st) {
    st.textContent = txt;
    st.classList.remove('ok','danger');
    if (cls) st.classList.add(cls);
  }
  if (overlayText) overlayText.textContent = txt;
}

function setLoading(card, on){
  const fig = card.querySelector('.figure');
  const img = fig.querySelector('img');
  if (on){
    fig.classList.remove('ready');
    fig.classList.add('loading');
    setStatus(card, 'ìƒì„± ì¤‘â€¦');
    img.classList.remove('loaded');
  } else {
    fig.classList.remove('loading');
  }
}

function updateImage(card, url){
  const fig = card.querySelector('.figure');
  const img = fig.querySelector('img');
  if (!url){
    setLoading(card, false);
    setStatus(card, 'ë¡œë“œ ì‹¤íŒ¨', 'danger');
    return;
  }
  if (img.src === url){
    img.classList.add('loaded');
    fig.classList.add('ready');
    setLoading(card, false);
    setStatus(card, '');
    maybeEnablePreview(); // âœ… ì¶”ê°€
    return;
  }
  img.onload = () => {
    img.classList.add('loaded');
    fig.classList.add('ready');
    setLoading(card, false);
    setStatus(card, '');
    maybeEnablePreview(); // âœ… ì¶”ê°€
  };
  img.onerror = () => {
    setLoading(card, false);
    setStatus(card, 'ë¡œë“œ ì‹¤íŒ¨', 'danger');
  };
  fig.classList.remove('ready');
  img.src = url;
}

/* -------------------- ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ í™œì„±í™” -------------------- */
function allLoaded(){
  return getCards().every(c=>{
    const img=c.querySelector('.figure img');
    return !!img.src && img.classList.contains('loaded');
  });
}
function maybeEnablePreview(){
  if(allLoaded()) previewBtn.disabled=false;
}

/* -------------------- API í˜¸ì¶œ -------------------- */
function payloadFrom(cards){
  return {
    style: styleSel.value,
    pages: cards.map(c=>({
      index: parseInt(c.dataset.index,10),
      text: (c.dataset.text||'').trim()
    }))
  };
}
async function callGenerate(body){
  const res = await fetch('/api/images/generate',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!res.ok) throw new Error('API '+res.status);
  const data=await res.json();
  return Array.isArray(data.images)?data.images:[];
}

/* -------------------- ì´ë¯¸ì§€ ìƒì„± ë¡œì§ -------------------- */
async function generateAll(){
  const cards=getCards();
  if(!cards.length)return;
  cards.forEach(c=>setLoading(c,true));
  try{
    const images=await callGenerate(payloadFrom(cards));
    const byIdx=new Map(images.map(x=>[Number(x.index),x.url]));
    cards.forEach(card=>{
      updateImage(card,byIdx.get(Number(card.dataset.index)));
    });
    maybeEnablePreview(); // âœ… ì „ì²´ ì™„ë£Œ í›„
  }catch(e){
    cards.forEach(c=>{setLoading(c,false);setStatus(c,'ìš”ì²­ ì‹¤íŒ¨','danger');});
  }
}

async function generateSelected(){
  const selected=getCards().filter(c=>c.querySelector('.ck').checked);
  if(!selected.length){alert('ë‹¤ì‹œ ìƒì„±í•  ì¹´ë“œë¥¼ ì²´í¬í•˜ì„¸ìš”.');return;}
  selected.forEach(c=>setLoading(c,true));
  try{
    const images=await callGenerate(payloadFrom(selected));
    const byIdx=new Map(images.map(x=>[Number(x.index),x.url]));
    selected.forEach(card=>{
      updateImage(card,byIdx.get(Number(card.dataset.index)));
      card.querySelector('.ck').checked=false;
    });
    maybeEnablePreview(); // âœ… ì¶”ê°€
  }catch(e){
    selected.forEach(c=>{setLoading(c,false);setStatus(c,'ìš”ì²­ ì‹¤íŒ¨','danger');});
  }
}

async function generateOne(card){
  setLoading(card,true);
  try{
    const images=await callGenerate(payloadFrom([card]));
    const url=(images[0]&&images[0].url)?images[0].url:'';
    updateImage(card,url);
    maybeEnablePreview(); // âœ… ì¶”ê°€
  }catch(e){
    setLoading(card,false);
    setStatus(card,'ìš”ì²­ ì‹¤íŒ¨','danger');
  }
}

/* -------------------- ì´ë²¤íŠ¸ -------------------- */
if(!allBtn.dataset.bound){
  allBtn.dataset.bound='1';
  allBtn.addEventListener('click',e=>{e.preventDefault();generateAll();});
}
if(!partialBtn.dataset.bound){
  partialBtn.dataset.bound='1';
  partialBtn.addEventListener('click',e=>{e.preventDefault();generateSelected();});
}
if(!backBtn.dataset.bound){
  backBtn.dataset.bound='1';
  backBtn.addEventListener('click',e=>{e.preventDefault();window.location.href="/editor?mode=write";});
}
if(!previewBtn.dataset.bound){
  previewBtn.dataset.bound='1';
  previewBtn.addEventListener('click',e=>{
    e.preventDefault();
    window.location.href="/preview";
  });
}

/* -------------------- ì¹´ë“œ ì´ˆê¸° ìƒíƒœ -------------------- */
getCards().forEach(card=>{
  if(card.dataset.bound)return;
  card.dataset.bound='1';
  const retry=card.querySelector('[data-action="retry"]');
  retry.addEventListener('click',e=>{e.preventDefault();generateOne(card);});
  setStatus(card,'ìƒì„± ì „');
});
</script>

</body>
</html>