<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì´ë¯¸ì§€ ìƒì„±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
  <style>
    /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ... */
    :root { --bg:#f7f9fb; --primary:#2563eb; --card:#fff; }
    body { font-family: sans-serif; background:var(--bg); margin:0; padding:20px; }
    .page { max-width: 1100px; margin: 0 auto; display:grid; grid-template-columns: 300px 1fr; gap:20px; }
    .toolbar { background:var(--card); padding:20px; border-radius:12px; height:fit-content; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:16px; }
    .card { background:#fff; border-radius:12px; overflow:hidden; border:1px solid #eee; }
    .figure { width:100%; aspect-ratio:2/3; background:#eee; position:relative; }
    .figure img { width:100%; height:100%; object-fit:cover; display:none; }
    .figure img.loaded { display:block; }
    .btn { display:block; width:100%; padding:12px; margin-bottom:10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-outline { background:#fff; border:1px solid #ddd; color:#333; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    @media(max-width:700px){ .page{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="page">
    <div class="toolbar">
      <h2 style="margin-top:0">{{ title }}</h2>
      <div style="margin-bottom:20px">
        <label>ìŠ¤íƒ€ì¼</label>
        <select id="style" style="width:100%; padding:8px; margin-top:5px">
          <option>ë™í™” ì¼ëŸ¬ìŠ¤íŠ¸ (ê¸°ë³¸)</option>
          <option>ìˆ˜ì±„í™”</option>
          <option>í¬ë ˆìš©</option>
        </select>
      </div>

      <button id="btnAll" class="btn btn-primary">ì „ì²´ ì´ë¯¸ì§€ ìƒì„±</button>
      <button id="btnPartial" class="btn btn-outline">ì„ íƒë§Œ ë‹¤ì‹œ ìƒì„±</button>
      <button id="btnBack" class="btn btn-outline">ê¸€ í¸ì§‘ìœ¼ë¡œ</button>

      <button id="btnSave" class="btn btn-primary" style="margin-top:20px; background:#10b981;" disabled>
        ğŸ’¾ ì €ì¥í•˜ê³  ì™„ì„±ë³¸ ë³´ê¸°
      </button>
      <p style="font-size:12px; color:#666">ëª¨ë“  ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ë©´ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <div class="grid" id="grid">
      {% for p in pages %}
      <div class="card" data-index="{{ p.index }}" data-text="{{ p.text }}">
        <div class="figure">
          <img src="{{ p.url }}" class="{{ 'loaded' if p.url else '' }}" alt="p{{ p.index }}">
          <div class="overlay" style="{{ 'display:none' if p.url else '' }}">ìƒì„± ì „</div>
        </div>
        <div style="padding:12px">
          <div style="font-size:13px; color:#666; margin-bottom:8px">{{ p.index }}. {{ p.text }}</div>
          <label><input type="checkbox" class="ck"> ë‹¤ì‹œ ìƒì„±</label>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <script>
    const title = "{{ title }}";
    const grid = document.getElementById('grid');
    const styleSel = document.getElementById('style');
    const btnAll = document.getElementById('btnAll');
    const btnPartial = document.getElementById('btnPartial');
    const btnSave = document.getElementById('btnSave');

    // ì¹´ë“œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const getCards = () => Array.from(grid.querySelectorAll('.card'));

    // ë²„íŠ¼ í™œì„±í™” ì²´í¬ (ì´ë¯¸ì§€ê°€ ë‹¤ ìˆìœ¼ë©´ ì €ì¥ ë²„íŠ¼ í™œì„±í™”)
    function checkReady() {
      const allReady = getCards().every(c => {
        const img = c.querySelector('img');
        return img.src && img.classList.contains('loaded');
      });
      btnSave.disabled = !allReady;
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ì²´í¬ (ë’¤ë¡œê°€ê¸°ë¡œ ì™”ì„ ë•Œ)
    checkReady();

    // ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateCard(card, url) {
      const img = card.querySelector('img');
      const overlay = card.querySelector('.overlay');
      if(url) {
        img.src = url;
        img.onload = () => {
          img.classList.add('loaded');
          if(overlay) overlay.style.display = 'none';
          checkReady();
        };
      }
    }

    // API í˜¸ì¶œ í—¬í¼
    async function generateImages(cards) {
      // ë¡œë”© í‘œì‹œ
      cards.forEach(c => {
        const overlay = c.querySelector('.overlay');
        if(overlay) { overlay.style.display = 'flex'; overlay.textContent = 'ìƒì„± ì¤‘...'; }
      });

      const payload = {
        style: styleSel.value,
        pages: cards.map(c => ({
          index: c.dataset.index,
          text: c.dataset.text
        }))
      };

      try {
        const res = await fetch('/api/images/generate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        // ê²°ê³¼ ë°˜ì˜
        data.images.forEach(item => {
          const card = grid.querySelector(`.card[data-index="${item.index}"]`);
          if(card) updateCard(card, item.url);
        });
      } catch(e) {
        alert('ìƒì„± ì‹¤íŒ¨');
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    btnAll.onclick = () => generateImages(getCards());

    btnPartial.onclick = () => {
      const selected = getCards().filter(c => c.querySelector('.ck').checked);
      if(!selected.length) return alert('ì„ íƒëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
      generateImages(selected);
      selected.forEach(c => c.querySelector('.ck').checked = false);
    };

    // [ìˆ˜ì •] ëª…í™•í•˜ê²Œ ì—ë””í„° í˜ì´ì§€ë¡œ ì´ë™í•˜ë„ë¡ ë³€ê²½
    document.getElementById('btnBack').onclick = () => {
      window.location.href = '/editor';
    };

    // [í•µì‹¬] ì €ì¥ ë° ì´ë™
    btnSave.onclick = async () => {
      btnSave.textContent = "ì €ì¥ ì¤‘...";
      btnSave.disabled = true;

      // í˜„ì¬ í™”ë©´ì˜ ì´ë¯¸ì§€ URL ìˆ˜ì§‘
      const pagesData = getCards().map(c => ({
        index: c.dataset.index,
        text: c.dataset.text,
        url: c.querySelector('img').src
      }));

      try {
        const res = await fetch('/api/story/save', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ title: title, pages: pagesData })
        });
        const data = await res.json();

        if(data.ok) {
          // ì €ì¥ ì„±ê³µ ì‹œ ì™„ì„±ë³¸ í˜ì´ì§€(DBë²„ì „)ë¡œ ì´ë™
          window.location.href = "/preview/" + data.story_id;
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
          btnSave.disabled = false;
        }
      } catch(e) {
        console.error(e);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        btnSave.disabled = false;
      }
    };
  </script>
</body>
</html>