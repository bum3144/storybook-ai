<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>í‘œì§€ ê¾¸ë¯¸ê¸°</title>
  <style>
    body { margin:0; font-family:-apple-system, sans-serif; background:#f3f4f6; color:#111; display:flex; height:100vh; overflow:hidden; }

    /* ì¢Œì¸¡ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
    .controls { width: 340px; background:#fff; border-right:1px solid #ddd; padding:25px; display:flex; flex-direction:column; gap:20px; overflow-y:auto; box-sizing:border-box; flex-shrink:0; }
    h2 { margin:0; font-size:22px; font-weight:700; }

    .group { display:grid; gap:8px; }
    label { font-size:14px; font-weight:600; color:#333; display:flex; justify-content:space-between; align-items:center; }
    .helper { font-size:12px; color:#888; font-weight:400; }
    input, select, button, textarea { padding:12px; border:1px solid #ddd; border-radius:8px; width:100%; box-sizing:border-box; font-family:inherit; }
    textarea { resize: vertical; height: 80px; }

    .btn { cursor:pointer; font-weight:bold; transition:0.2s; border:none; font-size:15px; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-primary:hover:not(:disabled) { background:#1d4ed8; }
    .btn-outline { background:#fff; border:1px solid #ddd; color:#333; }
    .btn-outline:hover:not(:disabled) { background:#f9fafb; }

    /* ìš°ì¸¡ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
    .preview-area { flex:1; display:flex; align-items:center; justify-content:center; background:#e5e7eb; padding:20px; overflow:auto; }

    /* í¼ì¹¨ë©´ ì»¨í…Œì´ë„ˆ */
    .spread-book {
      display: flex;
      height: 80vh;
      max-height: 700px;
      aspect-ratio: 1.414 / 1;
      background: #fff;
      box-shadow: 0 30px 60px rgba(0,0,0,0.2);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .cover-page {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex; flex-direction: column;
    }

    /* ì•í‘œì§€ */
    .front-cover {
      background: #fff;
      border-right: 1px solid rgba(0,0,0,0.1);
    }
    .cover-img { position: absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }

    .text-layer {
      position: absolute; inset:0; z-index:10;
      display: flex; flex-direction:column; align-items:center;
      padding: 40px; text-align: center;
      justify-content: center;
    }
    .book-title-preview {
      font-size: 32px; font-weight: 800; line-height: 1.3;
      text-shadow: 0 2px 10px rgba(255,255,255,0.8);
      background: rgba(255,255,255,0.7);
      padding: 12px 24px; border-radius: 12px;
      margin-bottom: 16px;
      word-break: keep-all;
      max-width: 90%;
    }
    .book-author-preview {
      font-size: 18px; font-weight: 500;
      background: rgba(255,255,255,0.7);
      padding: 6px 16px; border-radius: 20px;
    }

    /* ë’·í‘œì§€ */
    .back-cover {
      display: flex; align-items: center; justify-content: center;
      color: rgba(0,0,0,0.4); font-weight: bold; font-size: 14px;
    }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ & ìŠ¤í”¼ë„ˆ */
    .loading {
      position:absolute; inset:0;
      background: #fff; /* ì™„ì „ ë¶ˆíˆ¬ëª… í°ìƒ‰ìœ¼ë¡œ ë®ì–´ì„œ ê¹œë¹¡ì„ ë°©ì§€ */
      display:none;
      flex-direction:column; align-items:center; justify-content:center;
      z-index:100;
      color: #2563eb; font-weight:bold; gap:15px;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div class="controls">
    <div>
      <h2>ğŸ¨ í‘œì§€ ê¾¸ë¯¸ê¸°</h2>
      <p style="font-size:14px; color:#666; margin-top:5px">í¼ì¹¨ë©´(ì•/ë’¤)ì„ í™•ì¸í•˜ë©° ë””ìì¸í•˜ì„¸ìš”.</p>
    </div>
    <hr style="border:0; border-top:1px solid #eee; margin:0;">

    <div class="group">
      <label>1. ì±… ì œëª©</label>
      <input type="text" id="titleInput" value="{{ story.title }}">
    </div>

    <div class="group">
      <label>2. ê·¸ë¦¼ ì„¤ëª… (í”„ë¡¬í”„íŠ¸)</label>
      <textarea id="promptInput" placeholder="ì˜ˆ: ìš°ì£¼ë³µì„ ì…ì€ ì•„ê¸° ê³ ì–‘ì´, ë°˜ì§ì´ëŠ” ë³„ ë°°ê²½, ë”°ëœ»í•œ ìˆ˜ì±„í™” ëŠë‚Œ"></textarea>
      <button id="btnGen" class="btn btn-primary" style="margin-top:5px">âœ¨ ê·¸ë¦¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸°</button>
      <p style="font-size:11px; color:#666; margin:3px 0 0 0">* ë¹„ì›Œë‘ë©´ ì œëª©ì— ë§ì¶° ìë™ìœ¼ë¡œ ê·¸ë ¤ì§‘ë‹ˆë‹¤.</p>
    </div>

    <div class="group">
      <label>3. ì œëª© ìœ„ì¹˜</label>
      <select id="posSelect">
        <option value="top">ìƒë‹¨ (Top)</option>
        <option value="middle" selected>ì¤‘ì•™ (Middle)</option>
        <option value="bottom">í•˜ë‹¨ (Bottom)</option>
      </select>
    </div>

    <div class="group">
      <label>4. ì‘ê°€ ì´ë¦„</label>
      <input type="text" id="authorInput" placeholder="ì§€ì€ì´" value="{{ cover.author_name if cover else '' }}">
    </div>

    <div class="group">
      <label>5. ë°°ê²½ìƒ‰ (ë’·í‘œì§€)</label>
      <div style="display:flex; gap:10px;">
        <input type="color" id="colorInput" value="{{ cover.back_color if cover else '#f3e8ff' }}" style="height:40px; padding:2px; flex:1;">
      </div>
    </div>

    <div style="flex:1"></div>

    <div class="group" style="gap:10px">
      <button id="btnSave" class="btn btn-primary" style="height:50px; font-size:17px;">ğŸ’¾ ì €ì¥í•˜ê³  ì™„ë£Œ</button>
      <button id="btnCancel" class="btn btn-outline" style="height:40px;">ì·¨ì†Œ</button>
    </div>
  </div>

  <div class="preview-area">
    <div class="spread-book">

        <div class="cover-page front-cover" id="frontCover">
            <div class="loading" id="loader">
               <div class="spinner"></div>
               <div>AI í™”ê°€ê°€ ì—´ì‹¬íˆ ê·¸ë¦¬ê³  ìˆì–´ìš”...</div>
            </div>

            <img id="coverImg" class="cover-img" src="{{ cover.front_image_url if cover else '' }}" style="display: {{ 'block' if cover and cover.front_image_url else 'none' }}">

            <div class="text-layer" id="textLayer">
              <div class="book-title-preview" id="previewTitle">{{ story.title }}</div>
              <div class="book-author-preview" id="previewAuthor">{{ cover.author_name if cover else 'ì§€ì€ì´' }}</div>
            </div>
        </div>

        <div class="cover-page back-cover" id="backCover">
            ë’·í‘œì§€
        </div>

    </div>
  </div>

  <script>
    const storyId = {{ story.id }};
    const storyGenre = "{{ story.genre }}";

    const titleInput = document.getElementById('titleInput');
    const promptInput = document.getElementById('promptInput');
    const btnGen = document.getElementById('btnGen');
    const btnSave = document.getElementById('btnSave');
    const btnCancel = document.getElementById('btnCancel');
    const posSelect = document.getElementById('posSelect');
    const authorInput = document.getElementById('authorInput');
    const colorInput = document.getElementById('colorInput');

    const coverImg = document.getElementById('coverImg');
    const textLayer = document.getElementById('textLayer');
    const previewTitle = document.getElementById('previewTitle');
    const previewAuthor = document.getElementById('previewAuthor');
    const backCover = document.getElementById('backCover');
    const frontCover = document.getElementById('frontCover');
    const loader = document.getElementById('loader');

    let currentImageUrl = coverImg.src || "";

    // ì‹¤ì‹œê°„ ë°˜ì‘
    titleInput.addEventListener('input', (e) => previewTitle.textContent = e.target.value || "ì œëª©");
    authorInput.addEventListener('input', (e) => previewAuthor.textContent = e.target.value || "ì§€ì€ì´");

    function updatePos() {
      const pos = posSelect.value;
      if(pos === 'top') {
        textLayer.style.justifyContent = 'flex-start'; textLayer.style.paddingTop = '60px';
      } else if(pos === 'bottom') {
        textLayer.style.justifyContent = 'flex-end'; textLayer.style.paddingBottom = '60px';
      } else {
        textLayer.style.justifyContent = 'center'; textLayer.style.padding = '40px';
      }
    }
    posSelect.addEventListener('change', updatePos);
    posSelect.value = "{{ cover.title_position if cover else 'middle' }}";
    updatePos();

    function updateColor(val) {
      backCover.style.backgroundColor = val;
      if(!currentImageUrl) frontCover.style.backgroundColor = val;
    }
    colorInput.addEventListener('input', (e) => updateColor(e.target.value));
    updateColor(colorInput.value);

    // [í•µì‹¬ ìˆ˜ì •] AI ìƒì„± ë¡œì§
    btnGen.addEventListener('click', async () => {
      const prompt = promptInput.value.trim();
      const title = titleInput.value.trim();

      // 1. ë¡œë”© ì‹œì‘
      loader.style.display = 'flex';
      btnGen.disabled = true;
      btnGen.textContent = "âœ¨ ê·¸ë¦¬ëŠ” ì¤‘...";

      try {
        // 2. ì„œë²„ ìš”ì²­
        const res = await fetch('/api/cover/generate_image', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ prompt, title, genre: storyGenre })
        });
        const data = await res.json();

        if(data.ok) {
          currentImageUrl = data.url;

          // 3. [ì¤‘ìš”] ì´ë¯¸ì§€ ë¡œë”© ëŒ€ê¸°
          // URLë§Œ ë„£ëŠ” ê²Œ ì•„ë‹ˆë¼, ì´ë¯¸ì§€ê°€ ë¡œë“œ ì™„ë£Œ(onload)ë  ë•Œê¹Œì§€ ë¡œë”©ì°½ì„ ë„ì§€ ì•ŠìŒ
          coverImg.onload = function() {
              loader.style.display = 'none'; // ë‹¤ ê·¸ë ¤ì§€ë©´ ê·¸ë•Œ ë¡œë”© ë”
              btnGen.disabled = false;
              btnGen.textContent = "âœ¨ ê·¸ë¦¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸°";
              coverImg.style.display = 'block';
          };

          // ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘
          coverImg.src = currentImageUrl;

        } else {
          throw new Error('ìƒì„± ì‹¤íŒ¨');
        }
      } catch(e) {
          console.error(e);
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          loader.style.display = 'none';
          btnGen.disabled = false;
          btnGen.textContent = "âœ¨ ê·¸ë¦¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸°";
      }
    });

    // ì €ì¥
    btnSave.addEventListener('click', async () => {
      const title = titleInput.value.trim();
      if(!title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');

      btnSave.textContent = 'ì €ì¥ ì¤‘...';
      btnSave.disabled = true;
      try {
        const payload = {
          story_id: storyId,
          title: title,
          image_url: currentImageUrl,
          position: posSelect.value,
          author: authorInput.value,
          color: colorInput.value
        };
        const res = await fetch('/api/cover/save', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if((await res.json()).ok) location.href = `/preview/${storyId}`;
        else { alert('ì €ì¥ ì‹¤íŒ¨'); btnSave.disabled=false; btnSave.textContent='ğŸ’¾ ì €ì¥í•˜ê³  ì™„ë£Œ'; }
      } catch(e) { alert('ì˜¤ë¥˜'); btnSave.disabled=false; btnSave.textContent='ğŸ’¾ ì €ì¥í•˜ê³  ì™„ë£Œ'; }
    });

    btnCancel.onclick = () => location.href = `/preview/${storyId}`;
  </script>
</body>
</html>