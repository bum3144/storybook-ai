<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ title }}</title>
  <style>
    :root { --border:#e5e7eb; --brand:#2563eb; --danger:#ef4444; }
    body{margin:0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background:#fff; color:#111}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}

    /* ìƒë‹¨ í—¤ë” */
    .header{display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee}
    .title{font-size:24px; font-weight:700}
    .actions{display:flex; gap:10px}

    .btn{padding:8px 14px; border-radius:8px; text-decoration:none; font-size:14px; cursor:pointer; border:1px solid #ddd; background:#fff; color:#333}
    .btn:hover{background:#f9fafb}
    .btn.primary{background:var(--brand); color:#fff; border-color:var(--brand)}
    .btn.danger{color:var(--danger); border-color:var(--danger)}
    .btn.danger:hover{background:#fef2f2}

    /* ë·°ì–´ ì˜ì—­ (í™”ì‚´í‘œ í¬í•¨) */
    .viewer-container { position: relative; display: flex; align-items: center; justify-content: center; gap: 20px; min-height: 500px; }
    .viewer { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center; width: 100%; }

    .img-box { width: 100%; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; border: 1px solid #eee; background: #f8f9fa; }
    .img-box img { width: 100%; height: 100%; object-fit: cover; }
    .text-box { font-size: 18px; line-height: 1.7; white-space: pre-wrap; padding: 20px; }

    /* ì¢Œìš° í™”ì‚´í‘œ ë²„íŠ¼ */
    .arrow {
        width: 50px; height: 50px; border-radius: 50%; border: 1px solid #ddd; background: #fff;
        font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10;
        user-select: none;
    }
    .arrow:hover { background: #f0f0f0; }
    .arrow:active { transform: translateY(1px); }

    /* í•˜ë‹¨ ì¸ë„¤ì¼ */
    .thumbs{display:flex; gap:10px; margin-top:30px; overflow-x:auto; padding-bottom:10px}
    .thumb{flex:0 0 100px; cursor:pointer; border:2px solid transparent; border-radius:8px; opacity:0.6; transition:0.2s}
    .thumb:hover{opacity:1}
    .thumb.active{border-color:var(--brand); opacity:1}
    .thumb img{width:100%; height:100px; object-fit:cover; border-radius:6px}

    /* ì¸ì‡„(PDF) ìŠ¤íƒ€ì¼ - ê°€ë¡œí˜•(Landscape Book Layout) */
    @page {
        size: A4 landscape; /* ê°€ë¡œ ë°©í–¥ ì„¤ì • */
        margin: 0;
    }
    @media print {
      body { background: #fff; }
      .header, .thumbs, .arrow, .nav-hint, .viewer-container { display: none !important; }

      .wrap { max-width: 100%; padding: 0; margin: 0; }

      /* ì¸ì‡„ìš© ë¦¬ìŠ¤íŠ¸ ë³´ì´ê¸° */
      .print-only-list { display: block !important; }

      /* ê° í˜ì´ì§€(í¼ì¹¨ë©´) ìŠ¤íƒ€ì¼ */
      .print-spread {
          display: flex;
          flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
          width: 100vw;
          height: 100vh;
          break-after: page; /* í˜ì´ì§€ ë„˜ê¹€ */
          page-break-after: always;
          align-items: center;
          justify-content: center;
      }

      /* ì™¼ìª½ ê·¸ë¦¼ */
      .print-left {
          width: 50%;
          height: 100%;
          padding: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-sizing: border-box;
      }
      .print-left img {
          max-width: 100%;
          max-height: 90%;
          object-fit: contain;
          border-radius: 8px;
          border: 1px solid #eee;
      }

      /* ì˜¤ë¥¸ìª½ ê¸€ */
      .print-right {
          width: 50%;
          height: 100%;
          padding: 60px;
          display: flex;
          align-items: center;
          justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
          font-size: 22px;
          line-height: 2.0;
          white-space: pre-wrap;
          box-sizing: border-box;
      }
    }

    .print-only-list { display: none; }
  </style>
</head>
<body id="body">
  <div class="wrap">
    <div class="header">
      <div class="title">ğŸ“– {{ title }}</div>
      <div class="actions">
        <a href="/dashboard" class="btn">ëŒ€ì‹œë³´ë“œ</a>

        <a href="/images" class="btn">â† ì´ë¯¸ì§€ ìƒì„±ìœ¼ë¡œ</a>
        <button onclick="handlePrint()" class="btn primary">PDF ì €ì¥ / ì¸ì‡„</button>
        <button onclick="handleDelete()" class="btn danger">ì‚­ì œ</button>
      </div>
    </div>

    <div class="viewer-container">
        <button class="arrow" onclick="moveSlide(-1)">â€¹</button>

        <div class="viewer">
            <div class="img-box"><img id="mainImg" src="" alt="scene"></div>
            <div class="text-box" id="mainText"></div>
        </div>

        <button class="arrow" onclick="moveSlide(1)">â€º</button>
    </div>

    <div class="thumbs" id="thumbsList">
      {% for p in pages %}
      <div class="thumb" onclick="changePage({{ loop.index0 }})">
        <img src="{{ p.url }}" alt="p{{ p.index }}">
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="print-only-list">
    <div class="print-spread" style="flex-direction:column; justify-content:center; text-align:center;">
        <h1 style="font-size:48px; margin-bottom:20px;">{{ title }}</h1>
        <p style="font-size:20px; color:#666;">AI Storybook</p>
    </div>

    {% for p in pages %}
    <div class="print-spread">
      <div class="print-left">
          <img src="{{ p.url }}" alt="Scene {{ p.index }}">
      </div>
      <div class="print-right">
          <p>{{ p.text }}</p>
      </div>
    </div>
    {% endfor %}
  </div>

  <script>
    const pages = {{ pages|tojson }};
    const storyId = {{ story_id or 0 }};

    let currentIndex = 0;
    const mainImg = document.getElementById('mainImg');
    const mainText = document.getElementById('mainText');
    const thumbEls = document.getElementById('thumbsList').children;

    function changePage(idx) {
      if(idx < 0 || idx >= pages.length) return;
      currentIndex = idx;

      const p = pages[idx];
      mainImg.src = p.url;
      mainText.textContent = p.text;

      Array.from(thumbEls).forEach((el, i) => {
        el.classList.toggle('active', i === idx);
      });
    }

    function moveSlide(dir) {
        changePage(currentIndex + dir);
    }

    window.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowLeft') moveSlide(-1);
        if(e.key === 'ArrowRight') moveSlide(1);
    });

    if(pages.length > 0) changePage(0);

    function handlePrint() {
      window.print();
    }

    async function handleDelete() {
      if(!storyId) return alert('ì‚­ì œí•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.');

      if(confirm('ì •ë§ ì´ ë™í™”ì±…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        try {
          const res = await fetch('/api/story/' + storyId, { method: 'DELETE' });
          const data = await res.json();
          if(data.ok) {
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/dashboard';
          } else {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        } catch(e) {
          alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
        }
      }
    }
  </script>
</body>
</html>